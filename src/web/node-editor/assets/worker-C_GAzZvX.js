(function(){var e=Object.defineProperty,t=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n},n=class{getStyleConfig(){return{}}getInputs(){return this.defineInputs()}getOutputs(){return this.defineOutputs()}getStyle(){return this.getStyleConfig()}getInput(e,t,n){if(e&&Object.prototype.hasOwnProperty.call(e,t))return e[t];let r=this.defineInputs().find(e=>e.name===t);return r&&r.defaultValue!==void 0?r.defaultValue:n}createOutput(e,t,n){let r=this.defineOutputs();if(r.length===1&&!this.isPlainObject(e)){let[i]=r;return{outputs:{[i.name]:e},raw:t??e,summary:n,success:!0}}return{outputs:this.isPlainObject(e)?e:{},raw:t??e,summary:n,success:!0}}createError(e){return{success:!1,error:e instanceof Error?e.message:e,outputs:{}}}validateInputs(e){let t=[],n=this.defineInputs();for(let r of n)if(r.required){let n=e[r.name];(n==null||n===``)&&t.push(`"${r.name}" æ˜¯å¿…å¡«é¡¹`)}return{valid:t.length===0,errors:t}}getMetadata(){return{type:this.type,label:this.label,description:this.description,category:this.category,inputs:this.defineInputs(),outputs:this.defineOutputs(),style:this.getStyleConfig()}}shouldUseCache(e,t){return!0}getCacheableInputs(e){return e}computeConfigHash(e,t={}){let n=this.getCacheableInputs(e),r={type:this.type,inputs:n};return this.hashObject(r)}hashObject(e){let t=this.stableStringify(e),n=5381;for(let e=0;e<t.length;e++)n=n*33^t.charCodeAt(e);return(n>>>0).toString(16)}stableStringify(e){return e==null?String(e):typeof e==`object`?Array.isArray(e)?`[`+e.map(e=>this.stableStringify(e)).join(`,`)+`]`:`{`+Object.keys(e).sort().map(t=>JSON.stringify(t)+`:`+this.stableStringify(e[t])).join(`,`)+`}`:JSON.stringify(e)}isPlainObject(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}},r=class{constructor(e,t,n){this.state=`idle`,this.nodeStates=new Map,this.nodeOutputs=new Map,this.startTime=0,this.endTime=0,this.paused=!1,this.cancelled=!1,this.loopVariables=void 0,this.nodeIterationHistories=new Map,this.workflow=e,this.executionId=t,this.workflowCache=n}getExecutionId(){return this.executionId}getWorkflowId(){return this.workflow.workflow_id}getWorkflow(){return this.workflow}setState(e){this.state=e}getState(){return this.state}start(){this.state=`running`,this.startTime=Date.now()}complete(){this.state=`completed`,this.endTime=Date.now()}error(){this.state=`error`,this.endTime=Date.now()}pause(){this.paused=!0,this.state=`paused`}resume(){this.paused=!1,this.state=`running`}cancel(){this.cancelled=!0,this.state=`cancelled`,this.endTime=Date.now()}isPaused(){return this.paused}isCancelled(){return this.cancelled}getDuration(){return this.startTime===0?0:(this.endTime||Date.now())-this.startTime}getStartTime(){return this.startTime}getEndTime(){return this.endTime}setNodeState(e,t,n){let r={...this.nodeStates.get(e)||{nodeId:e,status:`pending`},status:t,...n};t===`running`&&!r.startTime&&(r.startTime=Date.now()),(t===`success`||t===`error`||t===`cached`)&&!r.endTime&&(r.endTime=Date.now(),r.startTime&&(r.duration=r.endTime-r.startTime)),this.nodeStates.set(e,r)}getNodeState(e){return this.nodeStates.get(e)}getAllNodeStates(){return new Map(this.nodeStates)}setNodeOutput(e,t){this.nodeOutputs.set(e,t)}getNodeOutput(e){return this.nodeOutputs.get(e)}getNodeInputs(e){let t={},n=this.workflow.edges.filter(t=>t.target===e);for(let e of n){let n=this.nodeOutputs.get(e.source);if(n){let r=e.targetHandle||`default`,i=e.sourceHandle||`default`;t[r]=n[i]??n}}return console.log(`[getNodeInputs]`,t),t}setCachedResult(e,t){this.workflowCache.set(e,t)}getCachedResult(e){return this.workflowCache.get(e)??null}clearCache(e){e&&e!==this.workflow.workflow_id||this.workflowCache.clear()}clearAllCache(){this.workflowCache.clear()}getCacheStats(e){e||=this.workflow.workflow_id;let t=this.workflowCache.size,n=this.workflow.nodes.length,r=n>0?t/n:0;return{totalNodes:n,cachedNodes:t,hitRate:r}}hasValidCache(e,t){let n=this.getCachedResult(e);return!n||t&&n.configHash!==t?!1:n.status===`success`}getProgress(){let e=this.workflow.nodes.length;if(e===0)return 1;let t=0;for(let e of this.nodeStates.values())(e.status===`success`||e.status===`error`||e.status===`cached`||e.status===`skipped`)&&t++;return t/e}reset(){this.state=`idle`,this.nodeStates.clear(),this.nodeOutputs.clear(),this.nodeIterationHistories.clear(),this.startTime=0,this.endTime=0,this.paused=!1,this.cancelled=!1}appendIterationResult(e,t){let n=this.nodeIterationHistories.get(e);n||(n={iterations:[],totalIterations:0,currentPage:1},this.nodeIterationHistories.set(e,n)),n.iterations.push(t),n.totalIterations=n.iterations.length;let r=this.nodeStates.get(e);r&&(r.iterationHistory={...n})}getIterationHistory(e){return this.nodeIterationHistories.get(e)}clearIterationHistory(e){this.nodeIterationHistories.delete(e)}clearAllIterationHistories(){this.nodeIterationHistories.clear()}},i=class{extractOutputs(e){let t=e.data;if(!t)return null;if(t.executionResult)return typeof t.executionResult==`object`&&!Array.isArray(t.executionResult)?t.executionResult:{default:t.executionResult};if(t.result?.data?.outputs){let e=t.result.data.outputs,n={};return Object.entries(e).forEach(([e,t])=>{t&&typeof t==`object`&&`value`in t?n[e]=t.value:n[e]=t}),n}return t.result?.data?.raw===void 0?null:{default:t.result.data.raw}}},a=class{constructor(e){this.context=e}extractOutputs(e){return this.context.getNodeOutput(e.id)||null}};function o(e,t,n){let r=new Set,i=[],a=new Map(n.map(e=>[e.id,e])),o=e=>{let n=t.filter(t=>t.target===e);for(let e of n){if(!e.source||r.has(e.source))continue;let t=a.get(e.source);if(!t)continue;let n=t.data?.config?.forNodeId;if(n){if(!a.get(n))continue;r.add(n),i.push(n),o(n);continue}r.add(e.source),i.push(e.source),o(e.source)}};return o(e),i}function s(e,t,n){return e==null?[]:Array.isArray(e)?e.map((e,r)=>{let i=`${t}[${r}]`;n.set(i,e);let a=e!=null&&(Array.isArray(e)||typeof e==`object`);return{id:i,label:`[${r}]`,valueType:l(e),reference:u(i),value:e,children:a?s(e,i,n):[]}}):typeof e==`object`?Object.entries(e).filter(([e])=>e!==`type`).map(([e,r])=>{let i=`${t}.${e}`;n.set(i,r);let a=r!=null&&(Array.isArray(r)||typeof r==`object`);return{id:i,label:e,valueType:l(r),reference:u(i),value:r,children:a?s(r,i,n):[]}}):[]}function c(e,t,n,r){if(t==null)return[];let i=n&&e?`${n}.${e}`:n||e;if(Array.isArray(t))return t.map((e,t)=>{let n=`${i}[${t}]`;r.set(n,e);let a=e!=null&&(Array.isArray(e)||typeof e==`object`);return{id:n,label:`[${t}]`,valueType:l(e),reference:u(n),value:e,children:a?s(e,n,r):[]}});if(typeof t==`object`){let a=Object.entries(t).filter(([e])=>e!==`type`),o=(e,t)=>e.map(([e,n])=>{let i=`${t}.${e}`;r.set(i,n);let a=n!=null&&(Array.isArray(n)||typeof n==`object`);return{id:i,label:e,valueType:l(n),reference:u(i),value:n,children:a?s(n,i,r):[]}});if(!e)return o(a,i);r.set(i,t);let c=o(a,i);return[{id:i,label:e,valueType:`object`,reference:u(i),value:t,children:c,nodeId:n,outputId:e}]}return r.set(i,t),[{id:i,label:e,valueType:l(t),reference:u(i),value:t,children:[],nodeId:n,outputId:e}]}function l(e){return e===null?`null`:e===void 0?`undefined`:Array.isArray(e)?`array`:typeof e}function u(e){return`{{ ${e} }}`}function d(e,t,n,r,a,l){let d=new Map(t.map(e=>[e.id,e])),f=new Map,p=[],m=d.get(e),h=m?.parentNode||m?.data?.parentNode,_=o(e,n,t).reverse(),v=null;if(h){let e=d.get(h);if(e?.type===`forLoopContainer`&&(v=e.data?.config?.forNodeId,!v)){for(let e of t)if(e.type===`for`&&e.data?.config?.containerId===h){v=e.id;break}}}let y=r||new i;if(a&&Object.keys(a).length>0){let e=`å…¨å±€å˜é‡`,t={id:`global-variables`,label:`å…¨å±€å˜é‡`,valueType:`object`,reference:e,value:{},children:[]};Object.entries(a).forEach(([n,r])=>{f.set(`${e}.${n}`,r);let i=c(n,r,e,f);t.children?.push(...i)}),p.push(t)}return _.forEach(e=>{let t=d.get(e);if(!t)return;let n=t.label||t.data?.label||e,r=t.type,i=y.extractOutputs(t);if(r===`for`){let r=t.data?.config||{},i=r.containerId;if(h&&i&&h===i&&v===e){let i={id:e,label:n,valueType:`node`,value:null,children:[],nodeId:e},a=r.itemName||`item`,o=r.indexName||`index`,d,m,h=[],_=!1,v=t.data?.params?.items;if(v!=null){let e=g(v,f);Array.isArray(e)&&(h=e)}l?(d=l[a],m=l[o],_=!0):(d=h.length>0?h[0]:null,m=0);let y=c(a,d,n,f);!_&&y[0]&&(y[0].label=y[0].label+` [ç¤ºä¾‹]`),y[0]&&i.children?.push(y[0]);let b=c(o,m,n,f);!_&&b[0]&&(b[0].label=b[0].label+` [ç¤ºä¾‹]`),b[0]&&i.children?.push(b[0]);let x=`${n}.list`;f.set(x,h);let S={id:x,label:`list`,valueType:`array`,reference:u(x),value:h,children:h.length>0?s(h,x,f):[],nodeId:e,outputId:`list`};i.children?.push(S),p.push(i);return}}if(!i||Object.keys(i).length===0)return;let a={id:e,label:n,valueType:`node`,value:null,children:[],nodeId:e};Object.entries(i).forEach(([e,t])=>{if(t===void 0)return;let r=t;if(r&&typeof r==`object`&&!Array.isArray(r)&&`data`in r){let e=r.data,t=r.isError;e&&typeof e==`object`&&(r={...e,...t===void 0?{}:{isError:t}})}let o=Object.keys(i);o.length===1&&o[0]===`default`?f.set(n,r):(f.set(n,r),f.set(`${n}.${e}`,r));let s=c(e,r,n,f);a.children?.push(...s)}),p.push(a)}),{tree:p.reverse(),map:f}}function f(e,t,n,r,i){let o=new a(t);return d(e,n,r,o,i,t.loopVariables)}function p(e,t){let n=JSON.parse(JSON.stringify(e));return m(n,t)}function m(e,t){if(typeof e==`string`)return g(e,t);if(Array.isArray(e))return e.map(e=>m(e,t));if(e&&typeof e==`object`){let n={};return Object.entries(e).forEach(([e,r])=>{n[e]=m(r,t)}),n}return e}let h=/\{\{\s*\$?([^{}]+?)\s*\}\}/g;function g(e,t){let n=[...e.matchAll(h)];if(n.length===0)return e;let r=n[0];if(!r)return e;if(n.length===1&&e.trim()===r[0]){let n=r[1];if(!n)return e;let i=n.trim(),a=t.get(i);return a===void 0?e:a}let i=e;return n.forEach(([e,n])=>{if(!n)return;let r=n.trim();if(!t.has(r))return;let a=t.get(r),o=typeof a==`string`?a:JSON.stringify(a,null,2);i=i.replace(e,o)}),i}var _=class{constructor(e,t){this.defaultOptions={timeout:6e4,maxRetries:3,useCache:!0,clearCache:!1},this.cacheStore=new Map,this.workflowNodeCounts=new Map,this.nodeResolver=e,t&&(this.defaultOptions={...this.defaultOptions,...t})}async execute(e,t){let n={...this.defaultOptions,...t},i=this.generateExecutionId(),a=new r(e,i,this.getWorkflowCache(e.workflow_id));this.currentContext=a,this.workflowNodeCounts.set(e.workflow_id,e.nodes.length),n.clearCache&&a.clearCache();try{a.start(),n.onProgress?.(0),this.emitExecutionStart(n,{executionId:i,workflowId:e.workflow_id});let t=this.determineStrategy(e),r=this.determineNodesToExecute(e,t),o=this.identifyContainerNodes(e.nodes),s=new Set;for(let t of e.nodes){let e=t.parentNode||t.data?.parentNode;e&&typeof e==`string`&&s.add(t.id)}let c=e.nodes.filter(e=>!o.has(e.id)&&!s.has(e.id)),l=e.edges.filter(e=>{let t=!o.has(e.source)&&!s.has(e.source),n=!o.has(e.target)&&!s.has(e.target);return t&&n});console.log(`[WorkflowExecutor] æ’é™¤ ${o.size} ä¸ªå®¹å™¨èŠ‚ç‚¹å’Œ ${s.size} ä¸ªå­èŠ‚ç‚¹åï¼Œå¯¹ ${c.length} ä¸ªé¡¶å±‚èŠ‚ç‚¹è¿›è¡Œæ‹“æ‰‘æ’åº`);let u=this.topologicalSort(c,l).filter(e=>r.has(e.id));for(let t of e.nodes){let e=r.has(t.id)?`pending`:`skipped`;a.setNodeState(t.id,e),e===`skipped`&&n.onNodeSkipped?.(t.id,`not-selected`)}for(let e of u){if(a.isPaused()&&await this.waitForResume(a),a.isCancelled())break;await this.executeNode(e,a,n);let t=a.getProgress();n.onProgress?.(t)}a.complete();let d=this.buildExecutionResult(a,t);return this.emitExecutionComplete(n,d),d}catch(t){a.error();let r=t instanceof Error?t.message:String(t),o=this.determineStrategy(e),s=this.buildExecutionResult(a,o,r);return this.emitExecutionError(n,{executionId:i,workflowId:e.workflow_id,error:r,result:s}),s}}pause(){this.currentContext?.pause()}resume(){this.currentContext?.resume()}stop(){this.currentContext?.cancel()}getState(){return this.currentContext?.getState()||`idle`}getCachedResult(e,t){return this.cacheStore.get(e)?.get(t)??null}clearCache(e){this.cacheStore.get(e)?.clear(),this.workflowNodeCounts.delete(e)}clearAllCache(){this.cacheStore.clear(),this.workflowNodeCounts.clear()}getCacheStats(e){let t=this.cacheStore.get(e),n=t?t.size:0,r=this.workflowNodeCounts.get(e)??0,i=r>0?n/r:0;return{totalNodes:r,cachedNodes:n,hitRate:i}}determineStrategy(e){let t=e.selectedNodeIds;return!t||t.length===0?`full`:t.length===1?`single`:`selective`}determineNodesToExecute(e,t){let n=new Set;if(t===`full`)return this.findReachableNodesFromStart(e.nodes,e.edges);let r=e.selectedNodeIds||[];for(let t of r)n.add(t),this.findDependencies(t,e.nodes,e.edges).forEach(e=>n.add(e));return n}findReachableNodesFromStart(e,t){let n=e.filter(e=>e.data?.nodeType===`start`||e.type===`start`);if(n.length===0)return console.warn(`[WorkflowExecutor] å·¥ä½œæµä¸­æ²¡æœ‰æ‰¾åˆ°å¼€å§‹èŠ‚ç‚¹ï¼Œå°†ä¸æ‰§è¡Œä»»ä½•èŠ‚ç‚¹`),new Set;n.length>1&&console.warn(`[WorkflowExecutor] å·¥ä½œæµä¸­å‘ç°å¤šä¸ªå¼€å§‹èŠ‚ç‚¹ï¼ˆ${n.length}ä¸ªï¼‰ï¼Œå°†ä»æ‰€æœ‰å¼€å§‹èŠ‚ç‚¹å‡ºå‘`);let r=new Set,i=n.map(e=>e.id);for(n.forEach(e=>r.add(e.id));i.length>0;){let e=i.shift(),n=t.filter(t=>t.source===e);for(let e of n)r.has(e.target)||(r.add(e.target),i.push(e.target))}return console.log(`[WorkflowExecutor] ä»å¼€å§‹èŠ‚ç‚¹å‡ºå‘ï¼Œæ‰¾åˆ° ${r.size} ä¸ªå¯è¾¾èŠ‚ç‚¹`),r}findDependencies(e,t,n){let r=new Set,i=new Set,a=e=>{if(i.has(e))return;i.add(e);let t=n.filter(t=>t.target===e);for(let e of t)r.add(e.source),a(e.source)};return a(e),r}shouldSkipNodeDueToInvalidInputs(e,t){let n=t.getWorkflow(),r=n.edges.filter(t=>t.target===e);if(r.length===0)return!1;let i=!1,a=!1;for(let e of r){let r=n.nodes.find(t=>t.id===e.source);if(!r||(r.data?.nodeType||r.type)!==`if`)continue;i=!0;let o=t.getNodeOutput(e.source);if(!o)continue;let s=e.sourceHandle||`default`;if(o[s]!=null){a=!0;break}}return i&&!a}topologicalSort(e,t){let n=new Map,r=new Map;for(let t of e)n.set(t.id,[]),r.set(t.id,0);for(let e of t)n.get(e.source)?.push(e.target),r.set(e.target,(r.get(e.target)||0)+1);let i=[],a=[];for(let[e,t]of r.entries())t===0&&i.push(e);for(;i.length>0;){let e=i.shift();a.push(e);let t=n.get(e)||[];for(let e of t){let t=(r.get(e)||0)-1;r.set(e,t),t===0&&i.push(e)}}if(a.length!==e.length)throw Error(`å·¥ä½œæµä¸­å­˜åœ¨å¾ªç¯ä¾èµ–`);return a.map(t=>e.find(e=>e.id===t))}async executeNode(e,t,n){let r=e.id;try{let i=e.data?.nodeType||e.type;if(this.shouldSkipNodeDueToInvalidInputs(r,t)){console.log(`[WorkflowExecutor] è·³è¿‡èŠ‚ç‚¹ ${r}: æ‰€æœ‰è¾“å…¥ç«¯å£éƒ½æ²¡æœ‰æœ‰æ•ˆæ•°æ®`),t.setNodeState(r,`skipped`),n.onNodeSkipped?.(r,`no-valid-input`);return}let a=t.getNodeInputs(r);if(console.log(`[WorkflowExecutor] èŠ‚ç‚¹ ${r} (${i}) åˆå§‹è¾“å…¥:`,{inputs:Object.keys(a),hasParams:!!e.data?.params}),e.data?.params){console.log(`[WorkflowExecutor] èŠ‚ç‚¹ ${r} çš„ params:`,e.data.params);let{map:i}=f(r,t,t.getWorkflow().nodes,t.getWorkflow().edges,n.globalVariables),o=p(e.data.params,i);console.log(`[WorkflowExecutor] èŠ‚ç‚¹ ${r} è§£æåçš„ params:`,o),Object.assign(a,o),console.log(`[WorkflowExecutor] èŠ‚ç‚¹ ${r} åˆå¹¶åçš„ inputs:`,Object.keys(a))}let o=!1,s;if(n.useCache){let c=this.nodeResolver.resolveInstance(i);if(o=c.shouldUseCache(a,{nodeId:r,workflowId:t.getWorkflowId()}),o&&(s=c.computeConfigHash(a,e.data||{}),t.hasValidCache(r,s))){let e=t.getCachedResult(r);t.setNodeState(r,`cached`,{outputs:e.outputs,fromCache:!0,duration:e.duration,inputs:e.inputs}),t.setNodeOutput(r,e.outputs),n.onCacheHit?.(r,e);return}}t.setNodeState(r,`running`),n.onNodeStart?.(r);let c=this.nodeResolver.resolve(i),l={nodeId:r,nodeData:e.data,workflowId:t.getWorkflowId()};i===`for`&&(l.executeContainer=async(e,r)=>await this.executeContainerNodes(e,r,t,n));let u=await this.executeWithTimeout(()=>c(a,l),n.timeout);if(u&&typeof u==`object`&&`success`in u&&u.success===!1){let e=u.error||`èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥`;throw Error(e)}let d=u?.outputs??{};if(t.setNodeOutput(r,d),t.setNodeState(r,`success`,{outputs:d,inputs:a}),o&&s){let e=t.getNodeState(r);t.setCachedResult(r,{nodeId:r,status:`success`,timestamp:Date.now(),outputs:d,inputs:a,duration:e.duration||0,configHash:s})}n.onNodeComplete?.(r,d)}catch(e){let i=e instanceof Error?e.message:String(e);throw t.setNodeState(r,`error`,{error:i}),n.onNodeError?.(r,e instanceof Error?e:Error(i)),e}}async executeWithTimeout(e,t=6e4){return new Promise((n,r)=>{let i=setTimeout(()=>{r(Error(`æ‰§è¡Œè¶…æ—¶`))},t);e().then(e=>{clearTimeout(i),n(e)}).catch(e=>{clearTimeout(i),r(e)})})}async waitForResume(e){return new Promise(t=>{let n=setInterval(()=>{e.isPaused()||(clearInterval(n),t())},100)})}buildExecutionResult(e,t,n){let r=e.getAllNodeStates(),i=[],a=[],o=[];for(let[e,t]of r.entries())t.status===`success`||t.status===`running`||t.status===`error`?i.push(e):t.status===`skipped`?a.push(e):t.status===`cached`&&o.push(e);return{success:e.getState()===`completed`&&!n,executionId:e.getExecutionId(),workflowId:e.getWorkflowId(),startTime:e.getStartTime(),endTime:e.getEndTime(),duration:e.getDuration(),nodeResults:r,executedNodeIds:i,skippedNodeIds:a,cachedNodeIds:o,strategy:t,error:n}}generateExecutionId(){return`exec_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}getWorkflowCache(e){return this.cacheStore.has(e)||this.cacheStore.set(e,new Map),this.cacheStore.get(e)}emitExecutionStart(e,t){e.onExecutionStart?.(t)}emitExecutionComplete(e,t){e.onExecutionComplete?.(t)}emitExecutionError(e,t){e.onExecutionError?.(t)}identifyContainerNodes(e){let t=new Set;for(let n of e){let e=n.parentNode||n.data?.parentNode;e&&typeof e==`string`&&(t.add(e),console.log(`[WorkflowExecutor] èŠ‚ç‚¹ ${n.id} çš„çˆ¶èŠ‚ç‚¹æ˜¯ ${e}ï¼ˆå®¹å™¨èŠ‚ç‚¹ï¼‰`))}return console.log(`[WorkflowExecutor] è¯†åˆ«åˆ° ${t.size} ä¸ªå®¹å™¨èŠ‚ç‚¹:`,Array.from(t)),t}async executeContainerNodes(e,t,n,r){let i=n.getWorkflow(),a=i.nodes.filter(t=>t.id!==e&&(t.data?.parentNode===e||t.parentNode===e));if(a.length===0)return console.warn(`[WorkflowExecutor] å®¹å™¨ ${e} å†…æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èŠ‚ç‚¹`),null;let o=t.index??0;if(console.log(`[WorkflowExecutor] å®¹å™¨ ${e} ç¬¬ ${o+1} æ¬¡è¿­ä»£ï¼Œå†…æœ‰ ${a.length} ä¸ªèŠ‚ç‚¹`),o===0){console.log(`[WorkflowExecutor] æ¸…ç©ºå®¹å™¨ ${e} å†… ${a.length} ä¸ªèŠ‚ç‚¹çš„è¿­ä»£å†å²`);for(let e of a)n.clearIterationHistory(e.id)}for(let e of a)n.setNodeState(e.id,`pending`);let s=new Set(a.map(e=>e.id)),c=i.edges.filter(t=>s.has(t.source)&&s.has(t.target)&&t.source!==e&&t.target!==e);console.log(`[WorkflowExecutor] å®¹å™¨å†…æœ‰ ${c.length} æ¡è¾¹`);let l=this.topologicalSort(a,c);n.loopVariables=t;let u=null;for(let e of l){if(n.isCancelled())break;await this.executeNode(e,n,r);let i=n.getNodeOutput(e.id),a=n.getNodeState(e.id);if(a){let s={iterationIndex:o,iterationVars:t,executionResult:i||null,executionStatus:a.status,executionDuration:a.duration,executionTimestamp:Date.now(),executionError:a.error};n.appendIterationResult(e.id,s),r.onIterationUpdate?.(e.id,s),console.log(`[WorkflowExecutor] ä¿å­˜èŠ‚ç‚¹ ${e.id} ç¬¬ ${o+1} æ¬¡è¿­ä»£ç»“æœ:`,{status:a.status,hasOutput:!!i})}i&&(u=i)}return n.loopVariables=void 0,u}},v=class{constructor(e){this.metadataCache=new Map,this.registry=e}getNodeClass(e){let t=this.registry[e];if(!t)throw Error(`æœªçŸ¥çš„èŠ‚ç‚¹ç±»å‹: ${e}`);return t}resolveInstance(e){return new(this.getNodeClass(e))}resolve(e){let t=this.getNodeClass(e);return async(e,n)=>await new t().execute(e,n)}getMetadata(e){if(this.metadataCache.has(e))return this.metadataCache.get(e);let t=new(this.getNodeClass(e)),n=t.getMetadata(),r={type:t.type,label:n.label,description:n.description,inputs:t.getInputs().map(e=>({name:e.name,label:e.description||e.name,type:e.type||`any`,required:e.required})),outputs:t.getOutputs().map(e=>({name:e.name,label:e.description||e.name,type:e.type||`any`})),category:n.category,icon:n.style?.icon};return this.metadataCache.set(e,r),r}getCode(e){try{return new(this.getNodeClass(e))().execute.toString()}catch(t){console.error(`è·å–èŠ‚ç‚¹ä»£ç å¤±è´¥ [${e}]:`,t);return}}hasNode(e){return e in this.registry}getAllTypes(){return Object.keys(this.registry)}clearCache(){this.metadataCache.clear()}};function y(e){return new v(e)}var b=typeof global==`object`&&global&&global.Object===Object&&global,x=typeof self==`object`&&self&&self.Object===Object&&self,S=b||x||Function(`return this`)(),C=S.Symbol,ee=Object.prototype,te=ee.hasOwnProperty,ne=ee.toString,w=C?C.toStringTag:void 0;function re(e){var t=te.call(e,w),n=e[w];try{e[w]=void 0;var r=!0}catch{}var i=ne.call(e);return r&&(t?e[w]=n:delete e[w]),i}var ie=re,ae=Object.prototype.toString;function oe(e){return ae.call(e)}var se=oe,ce=`[object Null]`,le=`[object Undefined]`,ue=C?C.toStringTag:void 0;function de(e){return e==null?e===void 0?le:ce:ue&&ue in Object(e)?ie(e):se(e)}var T=de;function fe(e){return typeof e==`object`&&!!e}var E=fe,D=Array.isArray;function pe(e){var t=typeof e;return e!=null&&(t==`object`||t==`function`)}var me=pe,he=`[object AsyncFunction]`,ge=`[object Function]`,_e=`[object GeneratorFunction]`,ve=`[object Proxy]`;function ye(e){if(!me(e))return!1;var t=T(e);return t==ge||t==_e||t==he||t==ve}var be=ye,xe=S[`__core-js_shared__`],Se=function(){var e=/[^.]+$/.exec(xe&&xe.keys&&xe.keys.IE_PROTO||``);return e?`Symbol(src)_1.`+e:``}();function Ce(e){return!!Se&&Se in e}var we=Ce,Te=Function.prototype.toString;function Ee(e){if(e!=null){try{return Te.call(e)}catch{}try{return e+``}catch{}}return``}var O=Ee,De=/[\\^$.*+?()[\]{}|]/g,Oe=/^\[object .+?Constructor\]$/,ke=Function.prototype,Ae=Object.prototype,je=ke.toString,Me=Ae.hasOwnProperty,Ne=RegExp(`^`+je.call(Me).replace(De,`\\$&`).replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,`$1.*?`)+`$`);function Pe(e){return!me(e)||we(e)?!1:(be(e)?Ne:Oe).test(O(e))}var Fe=Pe;function Ie(e,t){return e?.[t]}var Le=Ie;function Re(e,t){var n=Le(e,t);return Fe(n)?n:void 0}var k=Re,ze=k(S,`WeakMap`),Be=9007199254740991,Ve=/^(?:0|[1-9]\d*)$/;function He(e,t){var n=typeof e;return t??=Be,!!t&&(n==`number`||n!=`symbol`&&Ve.test(e))&&e>-1&&e%1==0&&e<t}var Ue=He;function We(e,t){return e===t||e!==e&&t!==t}var Ge=We,Ke=9007199254740991;function qe(e){return typeof e==`number`&&e>-1&&e%1==0&&e<=Ke}var Je=qe;function Ye(e){return e!=null&&Je(e.length)&&!be(e)}var Xe=Ye,Ze=Object.prototype;function Qe(e){var t=e&&e.constructor,n=typeof t==`function`&&t.prototype||Ze;return e===n}var $e=Qe;function et(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}var tt=et,nt=`[object Arguments]`;function rt(e){return E(e)&&T(e)==nt}var it=rt,at=Object.prototype,ot=at.hasOwnProperty,st=at.propertyIsEnumerable,ct=it(function(){return arguments}())?it:function(e){return E(e)&&ot.call(e,`callee`)&&!st.call(e,`callee`)};function lt(){return!1}var ut=lt,dt=typeof exports==`object`&&exports&&!exports.nodeType&&exports,ft=dt&&typeof module==`object`&&module&&!module.nodeType&&module,pt=ft&&ft.exports===dt?S.Buffer:void 0,mt=(pt?pt.isBuffer:void 0)||ut,ht=`[object Arguments]`,gt=`[object Array]`,_t=`[object Boolean]`,vt=`[object Date]`,yt=`[object Error]`,bt=`[object Function]`,xt=`[object Map]`,St=`[object Number]`,Ct=`[object Object]`,wt=`[object RegExp]`,Tt=`[object Set]`,Et=`[object String]`,Dt=`[object WeakMap]`,Ot=`[object ArrayBuffer]`,kt=`[object DataView]`,At=`[object Float32Array]`,jt=`[object Float64Array]`,Mt=`[object Int8Array]`,Nt=`[object Int16Array]`,Pt=`[object Int32Array]`,Ft=`[object Uint8Array]`,It=`[object Uint8ClampedArray]`,Lt=`[object Uint16Array]`,Rt=`[object Uint32Array]`,A={};A[At]=A[jt]=A[Mt]=A[Nt]=A[Pt]=A[Ft]=A[It]=A[Lt]=A[Rt]=!0,A[ht]=A[gt]=A[Ot]=A[_t]=A[kt]=A[vt]=A[yt]=A[bt]=A[xt]=A[St]=A[Ct]=A[wt]=A[Tt]=A[Et]=A[Dt]=!1;function zt(e){return E(e)&&Je(e.length)&&!!A[T(e)]}var Bt=zt;function Vt(e){return function(t){return e(t)}}var Ht=Vt,Ut=typeof exports==`object`&&exports&&!exports.nodeType&&exports,j=Ut&&typeof module==`object`&&module&&!module.nodeType&&module,Wt=j&&j.exports===Ut&&b.process,Gt=function(){try{return j&&j.require&&j.require(`util`).types||Wt&&Wt.binding&&Wt.binding(`util`)}catch{}}(),Kt=Gt&&Gt.isTypedArray,qt=Kt?Ht(Kt):Bt,Jt=Object.prototype.hasOwnProperty;function Yt(e,t){var n=D(e),r=!n&&ct(e),i=!n&&!r&&mt(e),a=!n&&!r&&!i&&qt(e),o=n||r||i||a,s=o?tt(e.length,String):[],c=s.length;for(var l in e)(t||Jt.call(e,l))&&!(o&&(l==`length`||i&&(l==`offset`||l==`parent`)||a&&(l==`buffer`||l==`byteLength`||l==`byteOffset`)||Ue(l,c)))&&s.push(l);return s}var Xt=Yt;function Zt(e,t){return function(n){return e(t(n))}}var Qt=Zt(Object.keys,Object),$t=Object.prototype.hasOwnProperty;function en(e){if(!$e(e))return Qt(e);var t=[];for(var n in Object(e))$t.call(e,n)&&n!=`constructor`&&t.push(n);return t}var tn=en;function nn(e){return Xe(e)?Xt(e):tn(e)}var rn=nn,M=k(Object,`create`);function an(){this.__data__=M?M(null):{},this.size=0}var on=an;function sn(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var cn=sn,ln=`__lodash_hash_undefined__`,un=Object.prototype.hasOwnProperty;function dn(e){var t=this.__data__;if(M){var n=t[e];return n===ln?void 0:n}return un.call(t,e)?t[e]:void 0}var fn=dn,pn=Object.prototype.hasOwnProperty;function mn(e){var t=this.__data__;return M?t[e]!==void 0:pn.call(t,e)}var hn=mn,gn=`__lodash_hash_undefined__`;function _n(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=M&&t===void 0?gn:t,this}var vn=_n;function N(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}N.prototype.clear=on,N.prototype.delete=cn,N.prototype.get=fn,N.prototype.has=hn,N.prototype.set=vn;var yn=N;function bn(){this.__data__=[],this.size=0}var xn=bn;function Sn(e,t){for(var n=e.length;n--;)if(Ge(e[n][0],t))return n;return-1}var P=Sn,Cn=Array.prototype.splice;function wn(e){var t=this.__data__,n=P(t,e);if(n<0)return!1;var r=t.length-1;return n==r?t.pop():Cn.call(t,n,1),--this.size,!0}var Tn=wn;function En(e){var t=this.__data__,n=P(t,e);return n<0?void 0:t[n][1]}var Dn=En;function On(e){return P(this.__data__,e)>-1}var kn=On;function An(e,t){var n=this.__data__,r=P(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this}var jn=An;function F(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}F.prototype.clear=xn,F.prototype.delete=Tn,F.prototype.get=Dn,F.prototype.has=kn,F.prototype.set=jn;var I=F,L=k(S,`Map`);function Mn(){this.size=0,this.__data__={hash:new yn,map:new(L||I),string:new yn}}var Nn=Mn;function Pn(e){var t=typeof e;return t==`string`||t==`number`||t==`symbol`||t==`boolean`?e!==`__proto__`:e===null}var Fn=Pn;function In(e,t){var n=e.__data__;return Fn(t)?n[typeof t==`string`?`string`:`hash`]:n.map}var R=In;function Ln(e){var t=R(this,e).delete(e);return this.size-=t?1:0,t}var Rn=Ln;function zn(e){return R(this,e).get(e)}var Bn=zn;function Vn(e){return R(this,e).has(e)}var Hn=Vn;function Un(e,t){var n=R(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this}var Wn=Un;function z(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}z.prototype.clear=Nn,z.prototype.delete=Rn,z.prototype.get=Bn,z.prototype.has=Hn,z.prototype.set=Wn;var Gn=z;function Kn(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}var qn=Kn;function Jn(){this.__data__=new I,this.size=0}var Yn=Jn;function Xn(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}var Zn=Xn;function Qn(e){return this.__data__.get(e)}var $n=Qn;function er(e){return this.__data__.has(e)}var tr=er,nr=200;function rr(e,t){var n=this.__data__;if(n instanceof I){var r=n.__data__;if(!L||r.length<nr-1)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new Gn(r)}return n.set(e,t),this.size=n.size,this}var ir=rr;function B(e){this.size=(this.__data__=new I(e)).size}B.prototype.clear=Yn,B.prototype.delete=Zn,B.prototype.get=$n,B.prototype.has=tr,B.prototype.set=ir;var ar=B;function or(e,t){for(var n=-1,r=e==null?0:e.length,i=0,a=[];++n<r;){var o=e[n];t(o,n,e)&&(a[i++]=o)}return a}var sr=or;function cr(){return[]}var lr=cr,ur=Object.prototype.propertyIsEnumerable,dr=Object.getOwnPropertySymbols,fr=dr?function(e){return e==null?[]:(e=Object(e),sr(dr(e),function(t){return ur.call(e,t)}))}:lr;function pr(e,t,n){var r=t(e);return D(e)?r:qn(r,n(e))}var mr=pr;function hr(e){return mr(e,rn,fr)}var gr=hr,_r=k(S,`DataView`),V=k(S,`Promise`),vr=k(S,`Set`),yr=`[object Map]`,br=`[object Object]`,xr=`[object Promise]`,Sr=`[object Set]`,Cr=`[object WeakMap]`,wr=`[object DataView]`,Tr=O(_r),Er=O(L),Dr=O(V),Or=O(vr),kr=O(ze),H=T;(_r&&H(new _r(new ArrayBuffer(1)))!=wr||L&&H(new L)!=yr||V&&H(V.resolve())!=xr||vr&&H(new vr)!=Sr||ze&&H(new ze)!=Cr)&&(H=function(e){var t=T(e),n=t==br?e.constructor:void 0,r=n?O(n):``;if(r)switch(r){case Tr:return wr;case Er:return yr;case Dr:return xr;case Or:return Sr;case kr:return Cr}return t});var Ar=H,jr=S.Uint8Array,Mr=`__lodash_hash_undefined__`;function Nr(e){return this.__data__.set(e,Mr),this}var Pr=Nr;function Fr(e){return this.__data__.has(e)}var Ir=Fr;function U(e){var t=-1,n=e==null?0:e.length;for(this.__data__=new Gn;++t<n;)this.add(e[t])}U.prototype.add=U.prototype.push=Pr,U.prototype.has=Ir;var Lr=U;function Rr(e,t){for(var n=-1,r=e==null?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}var zr=Rr;function Br(e,t){return e.has(t)}var Vr=Br,Hr=1,Ur=2;function Wr(e,t,n,r,i,a){var o=n&Hr,s=e.length,c=t.length;if(s!=c&&!(o&&c>s))return!1;var l=a.get(e),u=a.get(t);if(l&&u)return l==t&&u==e;var d=-1,f=!0,p=n&Ur?new Lr:void 0;for(a.set(e,t),a.set(t,e);++d<s;){var m=e[d],h=t[d];if(r)var g=o?r(h,m,d,t,e,a):r(m,h,d,e,t,a);if(g!==void 0){if(g)continue;f=!1;break}if(p){if(!zr(t,function(e,t){if(!Vr(p,t)&&(m===e||i(m,e,n,r,a)))return p.push(t)})){f=!1;break}}else if(!(m===h||i(m,h,n,r,a))){f=!1;break}}return a.delete(e),a.delete(t),f}var Gr=Wr;function Kr(e){var t=-1,n=Array(e.size);return e.forEach(function(e,r){n[++t]=[r,e]}),n}var qr=Kr;function Jr(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n}var Yr=Jr,Xr=1,Zr=2,Qr=`[object Boolean]`,$r=`[object Date]`,ei=`[object Error]`,ti=`[object Map]`,ni=`[object Number]`,ri=`[object RegExp]`,ii=`[object Set]`,ai=`[object String]`,oi=`[object Symbol]`,si=`[object ArrayBuffer]`,ci=`[object DataView]`,li=C?C.prototype:void 0,ui=li?li.valueOf:void 0;function di(e,t,n,r,i,a,o){switch(n){case ci:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case si:return!(e.byteLength!=t.byteLength||!a(new jr(e),new jr(t)));case Qr:case $r:case ni:return Ge(+e,+t);case ei:return e.name==t.name&&e.message==t.message;case ri:case ai:return e==t+``;case ti:var s=qr;case ii:var c=r&Xr;if(s||=Yr,e.size!=t.size&&!c)return!1;var l=o.get(e);if(l)return l==t;r|=Zr,o.set(e,t);var u=Gr(s(e),s(t),r,i,a,o);return o.delete(e),u;case oi:if(ui)return ui.call(e)==ui.call(t)}return!1}var fi=di,pi=1,mi=Object.prototype.hasOwnProperty;function hi(e,t,n,r,i,a){var o=n&pi,s=gr(e),c=s.length,l=gr(t).length;if(c!=l&&!o)return!1;for(var u=c;u--;){var d=s[u];if(!(o?d in t:mi.call(t,d)))return!1}var f=a.get(e),p=a.get(t);if(f&&p)return f==t&&p==e;var m=!0;a.set(e,t),a.set(t,e);for(var h=o;++u<c;){d=s[u];var g=e[d],_=t[d];if(r)var v=o?r(_,g,d,t,e,a):r(g,_,d,e,t,a);if(!(v===void 0?g===_||i(g,_,n,r,a):v)){m=!1;break}h||=d==`constructor`}if(m&&!h){var y=e.constructor,b=t.constructor;y!=b&&`constructor`in e&&`constructor`in t&&!(typeof y==`function`&&y instanceof y&&typeof b==`function`&&b instanceof b)&&(m=!1)}return a.delete(e),a.delete(t),m}var gi=hi,_i=1,vi=`[object Arguments]`,yi=`[object Array]`,W=`[object Object]`,bi=Object.prototype.hasOwnProperty;function xi(e,t,n,r,i,a){var o=D(e),s=D(t),c=o?yi:Ar(e),l=s?yi:Ar(t);c=c==vi?W:c,l=l==vi?W:l;var u=c==W,d=l==W,f=c==l;if(f&&mt(e)){if(!mt(t))return!1;o=!0,u=!1}if(f&&!u)return a||=new ar,o||qt(e)?Gr(e,t,n,r,i,a):fi(e,t,c,n,r,i,a);if(!(n&_i)){var p=u&&bi.call(e,`__wrapped__`),m=d&&bi.call(t,`__wrapped__`);if(p||m){var h=p?e.value():e,g=m?t.value():t;return a||=new ar,i(h,g,n,r,a)}}return f?(a||=new ar,gi(e,t,n,r,i,a)):!1}var Si=xi;function Ci(e,t,n,r,i){return e===t?!0:e==null||t==null||!E(e)&&!E(t)?e!==e&&t!==t:Si(e,t,n,r,Ci,i)}var wi=Ci;function Ti(e,t){return wi(e,t)}var Ei=Ti,Di=t({DATA_TYPE_LABELS:()=>ki,IfNode:()=>ji,OPERATORS_BY_TYPE:()=>Ai,OPERATOR_LABELS:()=>Oi});let Oi={"is equal to":`ç­‰äº`,"is not equal to":`ä¸ç­‰äº`,exists:`å­˜åœ¨`,"does not exist":`ä¸å­˜åœ¨`,"is empty":`ä¸ºç©º`,"is not empty":`ä¸ä¸ºç©º`,contains:`åŒ…å«`,"does not contain":`ä¸åŒ…å«`,"starts with":`å¼€å¤´ä¸º`,"ends with":`ç»“å°¾ä¸º`,"is greater than":`å¤§äº`,"is less than":`å°äº`,"is greater than or equal to":`å¤§äºç­‰äº`,"is less than or equal to":`å°äºç­‰äº`,"is true":`ä¸ºçœŸ`,"is false":`ä¸ºå‡`,"is before":`æ—©äº`,"is after":`æ™šäº`,"is before or equal to":`æ—©äºæˆ–ç­‰äº`,"is after or equal to":`æ™šäºæˆ–ç­‰äº`,"length equal to":`é•¿åº¦ç­‰äº`,"length not equal to":`é•¿åº¦ä¸ç­‰äº`,"length greater than":`é•¿åº¦å¤§äº`,"length less than":`é•¿åº¦å°äº`,"length greater than or equal to":`é•¿åº¦å¤§äºç­‰äº`,"length less than or equal to":`é•¿åº¦å°äºç­‰äº`},ki={string:`å­—ç¬¦ä¸²`,number:`æ•°å­—`,date:`æ—¥æœŸ`,boolean:`å¸ƒå°”å€¼`,array:`æ•°ç»„`,object:`å¯¹è±¡`},Ai={string:[`is equal to`,`is not equal to`,`contains`,`does not contain`,`starts with`,`ends with`,`exists`,`does not exist`,`is empty`,`is not empty`,`length equal to`,`length not equal to`,`length greater than`,`length less than`,`length greater than or equal to`,`length less than or equal to`],number:[`is equal to`,`is not equal to`,`is greater than`,`is less than`,`is greater than or equal to`,`is less than or equal to`,`exists`,`does not exist`],date:[`is equal to`,`is not equal to`,`is before`,`is after`,`is before or equal to`,`is after or equal to`,`exists`,`does not exist`],boolean:[`is equal to`,`is not equal to`,`is true`,`is false`,`exists`,`does not exist`],array:[`exists`,`does not exist`,`is empty`,`is not empty`,`contains`,`does not contain`,`length equal to`,`length not equal to`,`length greater than`,`length less than`,`length greater than or equal to`,`length less than or equal to`],object:[`exists`,`does not exist`,`is empty`,`is not empty`]};var ji=class extends n{constructor(...e){super(...e),this.type=`if`,this.label=`æ¡ä»¶åˆ¤æ–­`,this.description=`æ ¹æ®æ¡ä»¶åˆ¤æ–­æ‰§è¡Œä¸åŒçš„åˆ†æ”¯`,this.category=`æµç¨‹æ§åˆ¶`,this.currentConfig=null}defineInputs(){return[{name:`config`,type:`object`,description:`æ¡ä»¶é…ç½®`,defaultValue:this.getDefaultConfig(),required:!1}]}defineOutputs(){return this.currentConfig?this.getOutputsForConfig(this.currentConfig):this.getOutputsForConfig(this.getDefaultConfig())}getOutputsForConfig(e){let t=e.conditions||[],n=Math.max(t.length,1),r=[];for(let e=0;e<n;e++){let n=t[e];r.push({name:this.getConditionOutputId(e),type:`any`,description:n?this.describeCondition(n):`æœªé…ç½®æ¡ä»¶`})}return r.push({name:`else`,type:`any`,description:`æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œ`}),r}updateConfig(e){this.currentConfig=e}getDefaultConfig(){return{conditions:[{logic:`and`,subConditions:[{field:``,dataType:`string`,operator:`is equal to`,value:``}]}]}}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#7c3aed`],icon:`â“`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`config`,this.getDefaultConfig());this.updateConfig(t);let n=Array.isArray(t.conditions)?t.conditions:[];console.log(`[IfNode] å¼€å§‹è¯„ä¼°æ¡ä»¶ï¼Œæ¡ä»¶æ•°é‡:`,n.length),console.log(`[IfNode] åŸå§‹æ¡ä»¶é…ç½®:`,JSON.stringify(n,null,2));let r=n.map((e,t)=>{console.log(`\n[IfNode] è¯„ä¼°æ¡ä»¶ ${t+1}:`,{logic:e.logic,subConditionsCount:e.subConditions.length});let n=e.subConditions.map((e,t)=>{console.log(`  [IfNode] å­æ¡ä»¶ ${t+1} - åŸå§‹å€¼:`,{field:e.field,value:e.value,operator:e.operator,dataType:e.dataType});let n=this.resolveOperandValue(e.field,e.dataType),r=this.resolveOperandValue(e.value,e.dataType);if(console.log(`  [IfNode] å­æ¡ä»¶ ${t+1} - è§£æåçš„å€¼:`,{actualValue:n,targetValue:r,actualType:typeof n,targetType:typeof r}),this.isEmptyCondition(e.field,e.value,e.operator))return console.log(`  [IfNode] å­æ¡ä»¶ ${t+1} - æœªé…ç½®ï¼ˆå·¦å³å€¼éƒ½ä¸ºç©ºï¼‰ï¼Œè¿”å› false`),{...e,actualValue:n,targetValue:r,result:!1};let i=this.compareValues(n,r,e.operator,e.dataType);return console.log(`  [IfNode] å­æ¡ä»¶ ${t+1} - æ¯”è¾ƒç»“æœ:`,i),{...e,actualValue:n,targetValue:r,result:i}}),r=e.logic===`or`?n.some(e=>e.result):n.every(e=>e.result);return console.log(`[IfNode] æ¡ä»¶ ${t+1} æœ€ç»ˆç»“æœ:`,{logic:e.logic,subResults:n.map(e=>e.result),conditionResult:r}),{index:t,outputId:this.getConditionOutputId(t),logic:e.logic,subResults:n,result:r}}),i=r.findIndex(e=>e.result),a=i!==-1;console.log(`
[IfNode] æ¡ä»¶è¯„ä¼°æ±‡æ€»:`,{totalConditions:r.length,firstPassedIndex:i,anyPassed:a,allResults:r.map((e,t)=>({index:t,outputId:e.outputId,result:e.result}))});let o={};r.forEach((e,t)=>{o[e.outputId]=t===i?{branch:e.outputId,passed:!0,evaluation:e,allEvaluations:r}:void 0}),o.else=a?void 0:{branch:`else`,passed:!1,allEvaluations:r};let s=i===-1?null:r[i];return console.log(`[IfNode] æœ€ç»ˆè¾“å‡ºç«¯å£:`,{selectedBranch:s?s.outputId:`else`,outputKeys:Object.keys(o),outputsWithData:Object.entries(o).filter(([e,t])=>t!==void 0).map(([e])=>e)}),this.createOutput(o,{branch:s?s.outputId:`else`,passed:a,evaluations:r},s?`æ¡ä»¶${i+1}æ»¡è¶³`:`æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæ‰§è¡Œ else`)}catch(e){return this.createError(e)}}getConditionOutputId(e){return`condition-${e}`}describeCondition(e){let{logic:t,subConditions:n}=e;if(!n||n.length===0)return`æœªé…ç½®å­æ¡ä»¶`;if(n.length===1)return this.describeSubCondition(n[0]);let r=t===`and`?` ä¸” `:` æˆ– `,i=n.map(e=>this.describeSubCondition(e)).join(r);return i.length>60?i.slice(0,57)+`...`:i}describeSubCondition(e){if(!e)return`æœªé…ç½®`;let t=this.formatOperand(e.field,`è¾“å…¥å€¼`),n=Oi[e.operator]||e.operator;if([`exists`,`does not exist`,`is empty`,`is not empty`,`is true`,`is false`].includes(e.operator))return`${t} ${n}`;let r=this.truncateValue(e.value,20,`''`);return`${t} ${n} ${r}`}truncateValue(e,t=48,n=``){let r=this.formatOperand(e,n);return r?r.length<=t?r:`${r.slice(0,t-1)}â€¦`:n}formatOperand(e,t=``){if(e==null)return t;if(typeof e==`string`){let n=e.trim();return n.length>0?n:t}if(typeof e==`number`||typeof e==`boolean`)return String(e);if(e instanceof Date)return e.toISOString();try{return JSON.stringify(e)}catch{return String(e)}}isEmptyCondition(e,t,n){return[`exists`,`does not exist`,`is empty`,`is not empty`,`is true`,`is false`].includes(n)?this.isOperandEmpty(e):this.isOperandEmpty(e)&&this.isOperandEmpty(t)}isOperandEmpty(e){return e==null?!0:typeof e==`string`?e.trim()===``:!1}resolveOperandValue(e,t){return e==null?e:this.coerceValueByType(e,t)}coerceValueByType(e,t){if(e==null)return e;switch(t){case`number`:{if(typeof e==`number`)return e;if(typeof e==`boolean`)return e?1:0;if(typeof e==`string`){let t=Number(e);return Number.isNaN(t)?e:t}let t=Number(e);return Number.isNaN(t)?e:t}case`boolean`:if(typeof e==`boolean`)return e;if(typeof e==`number`)return e!==0;if(typeof e==`string`){let t=e.toLowerCase();if([`true`,`1`,`yes`].includes(t))return!0;if([`false`,`0`,`no`].includes(t))return!1}return!!e;case`date`:if(e instanceof Date)return e;if(typeof e==`number`)return new Date(e);if(typeof e==`string`){let t=new Date(e);return Number.isNaN(t.getTime())?e:t}return e;case`array`:if(Array.isArray(e))return e;if(typeof e==`string`){let t=e.trim();if(!t)return[];try{let n=JSON.parse(t);return Array.isArray(n)?n:e}catch{return e}}return e;case`object`:if(e&&typeof e==`object`&&!Array.isArray(e))return e;if(typeof e==`string`){let t=e.trim();if(!t)return{};try{let n=JSON.parse(t);return n&&typeof n==`object`?n:e}catch{return e}}return e;default:return typeof e==`string`?e:String(e)}}compareValues(e,t,n,r){console.log(`    [IfNode.compareValues] æ¯”è¾ƒå‚æ•°:`,{actual:e,target:t,operator:n,dataType:r,actualType:typeof e,targetType:typeof t});let i;switch(n){case`is equal to`:return i=this.compareEquality(e,t,r),console.log(`    [IfNode.compareValues] is equal to ç»“æœ:`,i),i;case`is not equal to`:return!this.compareEquality(e,t,r);case`exists`:return e!=null;case`does not exist`:return e==null;case`is empty`:return e==null?!0:typeof e==`string`?e.trim().length===0:Array.isArray(e)?e.length===0:typeof e==`object`?Object.keys(e).length===0:!1;case`is not empty`:return e==null?!1:typeof e==`string`?e.trim().length>0:Array.isArray(e)?e.length>0:typeof e==`object`?Object.keys(e).length>0:!0;case`contains`:return typeof e==`string`&&typeof t==`string`||Array.isArray(e)?e.includes(t):!1;case`does not contain`:return typeof e==`string`&&typeof t==`string`||Array.isArray(e)?!e.includes(t):!0;case`starts with`:return typeof e==`string`&&typeof t==`string`?e.startsWith(t):!1;case`ends with`:return typeof e==`string`&&typeof t==`string`?e.endsWith(t):!1;case`is greater than`:return Number(e)>Number(t);case`is less than`:return Number(e)<Number(t);case`is greater than or equal to`:return Number(e)>=Number(t);case`is less than or equal to`:return Number(e)<=Number(t);case`is true`:return e===!0;case`is false`:return e===!1;case`is before`:return new Date(e)<new Date(t);case`is after`:return new Date(e)>new Date(t);case`is before or equal to`:return new Date(e)<=new Date(t);case`is after or equal to`:return new Date(e)>=new Date(t);case`length equal to`:return this.getLength(e)===Number(t);case`length not equal to`:return this.getLength(e)!==Number(t);case`length greater than`:return this.getLength(e)>Number(t);case`length less than`:return this.getLength(e)<Number(t);case`length greater than or equal to`:return this.getLength(e)>=Number(t);case`length less than or equal to`:return this.getLength(e)<=Number(t);default:return!1}}getLength(e){return typeof e==`string`||Array.isArray(e)?e.length:typeof e==`object`&&e?Object.keys(e).length:0}compareEquality(e,t,n){let r=this.normalizeEqualityValue(e,n),i=this.normalizeEqualityValue(t,n);return n===`array`||n===`object`?Ei(r,i):r===i}normalizeEqualityValue(e,t){if(e==null)return e;switch(t){case`number`:{let t=Number(e);return Number.isNaN(t)?e:t}case`boolean`:if(typeof e==`boolean`)return e;if(typeof e==`string`){let t=e.trim().toLowerCase();if(t===`true`||t===`1`)return!0;if(t===`false`||t===`0`)return!1}return typeof e==`number`?e===1:!!e;case`date`:{let t=e instanceof Date?e.getTime():new Date(e).getTime();return Number.isNaN(t)?e:t}case`string`:return String(e);default:return e}}},Mi=t({CodeNode:()=>Pi});let Ni=/^[A-Za-z][A-Za-z0-9_]*$/;var Pi=class extends n{constructor(...e){super(...e),this.type=`code`,this.label=`ä»£ç æ‰§è¡Œ`,this.description=`æ‰§è¡Œè‡ªå®šä¹‰ TypeScript/JavaScript ä»£ç `,this.category=`æ•°æ®å¤„ç†`}defineInputs(){return[{name:`dataItems`,type:`array`,description:`å‚æ•°å¯¹è±¡ï¼ˆå¦‚æä¾›åˆ™è¦†ç›–ç”± dataItems æ„å»ºçš„å‚æ•°ï¼‰`,required:!1},{name:`code`,type:`string`,description:`åŠ¨æ€ä»£ç ï¼ˆå¦‚æä¾›åˆ™è¦†ç›–é…ç½®ä¸­çš„ codeï¼‰`,required:!1}]}defineOutputs(){return[{name:`result`,type:`any`,description:`æ‰§è¡Œç»“æœ`}]}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#7c3aed`],showIcon:!0}}getDefaultConfig(){return{code:`export async function main(params) {
  return {
    receivedKeys: Object.keys(params),
    example: params,
  };
}`,dataItems:[]}}shouldUseCache(e,t){return!1}async execute(e,t){try{let t=this.getDefaultConfig(),n=this.getInput(e,`code`,``),r=typeof n==`string`&&n.trim()?n:void 0,i=this.getInput(e,`dataItems`,null),a=Array.isArray(i),o=i&&typeof i==`object`&&!a?i:void 0,s=r??t.code,c=o??this.buildParams(a?i:t.dataItems),l=this.prepareRuntime(s);try{let e=Function(`params`,l)(c),t=e instanceof Promise?await e:e,n={result:t};return this.createOutput(n,t,this.buildSummary(t,Object.keys(c)))}catch(e){throw Error(`ä»£ç æ‰§è¡Œé”™è¯¯: ${e?.message??e}`)}}catch(e){return this.createError(e)}}buildParams(e){let t={},n=new Set;return e.forEach((e,r)=>{let i=(e?.key??``).trim();if(!i){console.error(`ç¬¬ ${r+1} é¡¹çš„é”®åä¸èƒ½ä¸ºç©º`);return}if(!Ni.test(i)){console.error(`ç¬¬ ${r+1} é¡¹çš„é”®å "${i}" æ— æ•ˆï¼šä»…æ”¯æŒä»¥å­—æ¯å¼€å¤´ï¼Œç”±å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿ç»„æˆ`);return}if(n.has(i)){console.error(`æ£€æµ‹åˆ°é‡å¤çš„é”®å "${i}"ï¼Œè¯·ç¡®ä¿å”¯ä¸€`);return}n.add(i),t[i]=e?.value}),t}prepareRuntime(e){return`"use strict";
${this.normalizeExports(e)}

if (typeof main !== "function") {
  throw new Error("main å‡½æ•°æœªå®šä¹‰ï¼Œè¯·ç¡®ä¿å¯¼å‡º export function main(params) {}");
}

const result = main(params);
return result;`}normalizeExports(e){let t=e;return[[/export\s+default\s+async\s+function\s+main/g,`async function main`],[/export\s+default\s+function\s+main/g,`function main`],[/export\s+async\s+function\s+main/g,`async function main`],[/export\s+function\s+main/g,`function main`],[/export\s+default\s+main\s*;?/g,``],[/export\s+{\s*main\s+as\s+default\s*};?/g,``],[/export\s+const\s+main\s*=\s*/g,`const main = `],[/export\s+let\s+main\s*=\s*/g,`let main = `],[/export\s+var\s+main\s*=\s*/g,`var main = `]].forEach(([e,n])=>{t=t.replace(e,n)}),t}buildSummary(e,t){let n=t.length>0?t.join(`, `):`æ— `,r=this.formatValue(e);return`main(params) æ‰§è¡Œå®Œæˆ | å‚æ•°é”®: [${n}] | ç»“æœ: ${r}`}formatValue(e){if(e===null)return`null`;if(e===void 0)return`undefined`;if(typeof e==`string`)return e.length>40?`"${e.slice(0,37)}..."`:`"${e}"`;if(typeof e==`number`||typeof e==`boolean`)return String(e);if(Array.isArray(e))return`Array(${e.length})`;if(typeof e==`object`){let t=Object.keys(e);if(t.length===0)return`{}`;let n=t.slice(0,3).join(`, `),r=t.length>3?`, ...`:``;return`{ ${n}${r} }`}return String(e)}},Fi=t({ConnectorNode:()=>Ii}),Ii=class extends n{constructor(...e){super(...e),this.type=`connector`,this.label=`è¿æ¥`,this.description=`ç”¨äºä¼˜åŒ–è¿æ¥çº¿å¸ƒå±€ï¼Œæ‰§è¡Œæ—¶è¿”å› undefined`,this.category=`å·¥å…·`}defineInputs(){return[]}defineOutputs(){return[{name:`output`,type:`any`,description:`è¾“å‡ºæ•°æ®ï¼ˆundefinedï¼‰`}]}getStyleConfig(){return{}}async execute(e,t){return this.createOutput({output:void 0},void 0,`è¿æ¥èŠ‚ç‚¹ï¼šå·²è¿”å› undefined`)}},Li=t({ArrayFilterNode:()=>zi,DataMergeNode:()=>Ri}),Ri=class extends n{constructor(...e){super(...e),this.type=`data-merge`,this.label=`æ•°æ®åˆå¹¶`,this.description=`å°†å¤šä¸ªè¾“å…¥åˆå¹¶ä¸ºä¸€ä¸ªå¯¹è±¡`,this.category=`æ•°æ®å¤„ç†`}defineInputs(){return[{name:`input1`,type:`any`,description:`è¾“å…¥æ•°æ®1`,multiple:!0},{name:`input2`,type:`any`,description:`è¾“å…¥æ•°æ®2`,multiple:!0},{name:`input3`,type:`any`,description:`è¾“å…¥æ•°æ®3`}]}defineOutputs(){return[{name:`merged`,type:`object`,description:`åˆå¹¶åçš„å¯¹è±¡`}]}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#ec4899`],icon:`ğŸ”—`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`input1`),n=this.getInput(e,`input2`),r=this.getInput(e,`input3`),i={data1:t,data2:n,data3:r,mergedAt:new Date().toISOString()};return this.createOutput(i)}catch(e){return this.createError(e)}}},zi=class extends n{constructor(...e){super(...e),this.type=`array-filter`,this.label=`æ•°ç»„è¿‡æ»¤`,this.description=`æ ¹æ®æ¡ä»¶è¿‡æ»¤æ•°ç»„å…ƒç´ `,this.category=`æ•°æ®å¤„ç†`}defineInputs(){return[{name:`array`,type:`array`,description:`è¾“å…¥æ•°ç»„`,required:!0},{name:`condition`,type:`string`,description:`è¿‡æ»¤æ¡ä»¶ï¼ˆJavaScript è¡¨è¾¾å¼ï¼Œä½¿ç”¨ item è¡¨ç¤ºå½“å‰å…ƒç´ ï¼‰`,required:!0,defaultValue:`item > 0`}]}defineOutputs(){return[{name:`filtered`,type:`array`,description:`è¿‡æ»¤åçš„æ•°ç»„`},{name:`count`,type:`number`,description:`è¿‡æ»¤åçš„å…ƒç´ æ•°é‡`}]}getStyleConfig(){return{headerColor:`#10b981`,icon:`ğŸ”`,showIcon:!0,headerStyle:{fontWeight:`600`}}}async execute(e,t){try{let t=this.getInput(e,`array`,[]),n=this.getInput(e,`condition`,`true`);if(!Array.isArray(t))return this.createError(`è¾“å…¥å¿…é¡»æ˜¯æ•°ç»„ç±»å‹`);let r=Function(`item`,`return ${n}`),i=t.filter(r);return this.createOutput({filtered:i,count:i.length},i,`è¿‡æ»¤å®Œæˆï¼š${t.length} -> ${i.length} é¡¹`)}catch(e){return this.createError(e)}}},Bi=t({DelayNode:()=>Vi}),Vi=class extends n{constructor(...e){super(...e),this.type=`delay`,this.label=`å»¶è¿Ÿ`,this.description=`æš‚åœå·¥ä½œæµæ‰§è¡ŒæŒ‡å®šçš„æ—¶é—´`,this.category=`æ§åˆ¶æµ`}defineInputs(){return[{name:`delay`,type:`number`,description:`å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰`,required:!0,defaultValue:1e3}]}defineOutputs(){return[{name:`output`,type:`any`,description:`å»¶è¿Ÿåè¾“å‡ºçš„æ•°æ®`}]}getStyleConfig(){return{headerColor:[`#f59e0b`,`#d97706`],icon:`â±ï¸`,showIcon:!0}}shouldUseCache(e,t){return!1}async execute(e,t){try{let n=this.getInput(e,`delay`,1e3);return console.log(`DelayNode execute`,n),typeof n!=`number`||n<0?this.createError(`å»¶è¿Ÿæ—¶é—´å¿…é¡»æ˜¯éè´Ÿæ•°`):n===0?this.createOutput({output:void 0}):(await this.sleep(n,t.signal),this.createOutput({output:void 0},void 0,`å»¶è¿Ÿ ${n}ms å®Œæˆ`))}catch(e){return e instanceof Error&&e.name===`AbortError`?this.createError(`å»¶è¿Ÿè¢«å–æ¶ˆ`):this.createError(e)}}sleep(e,t){return new Promise((n,r)=>{if(t?.aborted){let e=Error(`å»¶è¿Ÿè¢«å–æ¶ˆ`);e.name=`AbortError`,r(e);return}let i=setTimeout(()=>{o(),n()},e),a=()=>{o();let e=Error(`å»¶è¿Ÿè¢«å–æ¶ˆ`);e.name=`AbortError`,r(e)},o=()=>{clearTimeout(i),t?.removeEventListener(`abort`,a)};t?.addEventListener(`abort`,a)})}},Hi=t({EndNode:()=>Ui}),Ui=class extends n{constructor(...e){super(...e),this.type=`end`,this.label=`ç»“æŸ`,this.description=`å·¥ä½œæµç¨‹çš„ç»“æŸèŠ‚ç‚¹`,this.category=`æ§åˆ¶æµ`}defineInputs(){return[{name:`input`,type:`any`,description:`æ¥æ”¶ä»»æ„è¾“å…¥`,required:!1}]}defineOutputs(){return[]}getStyleConfig(){return{headerColor:[`#ef4444`,`#dc2626`],icon:`â¹ï¸`,showIcon:!0}}async execute(e,t){let n=this.getInput(e,`input`,null);return{success:!0,summary:`å·¥ä½œæµç»“æŸ`,outputs:{},raw:{completed:!0,timestamp:Date.now(),finalInput:n}}}},Wi=t({ForNode:()=>Gi}),Gi=class extends n{constructor(...e){super(...e),this.type=`for`,this.label=`æ‰¹å¤„ç†`,this.description=`éå†é›†åˆå¹¶è¿è¡Œå¾ªç¯ä½“`,this.category=`æµç¨‹æ§åˆ¶`}defineInputs(){return[{name:`items`,type:`array`,description:`è¾“å…¥é›†åˆ`,required:!1}]}defineOutputs(){return[{name:`loop`,type:`any`,description:`å¾ªç¯ä½“`},{name:`next`,type:`any`,description:`å¾ªç¯ç»“æŸ`}]}getStyleConfig(){return{headerColor:[`#f97316`,`#ea580c`],showIcon:!0}}async execute(e,t){try{let n=this.getInput(e,`items`,[]);if(!Array.isArray(n))throw Error(`å¾ªç¯æºæ•°æ®å¿…é¡»æ˜¯æ•°ç»„`);let r=t.nodeData||{},i={...this.getDefaultConfig(),...r.config||{}};if(!i.containerId)throw Error(`For èŠ‚ç‚¹æœªé…ç½®å¾ªç¯ä½“å®¹å™¨`);if(!t.executeContainer)throw Error(`æ‰§è¡Œä¸Šä¸‹æ–‡ç¼ºå°‘ executeContainer æ–¹æ³•`);let a=n.map((e,t)=>({[i.itemName]:e,[i.indexName]:t,list:n}));if(a.length===0)return this.createOutput({next:{totalCount:0,executedCount:0,successCount:0,errorCount:0,results:[],summary:`æ— è¿­ä»£æ•°æ®`}},{count:0},`æ— è¿­ä»£æ•°æ®`);let o=i.pagination,s=o?.enabled??!1,c=o?.pageSize??10,l=o?.currentPage??1,u=a,d=0,f=a.length;s&&c>0?(d=(l-1)*c,f=Math.min(d+c,a.length),u=a.slice(d,f),console.log(`[ForNode] å¯ç”¨åˆ†é¡µï¼šç¬¬ ${l} é¡µï¼Œæ¯é¡µ ${c} æ¡ï¼Œæ‰§è¡Œ ${u.length} æ¬¡è¿­ä»£ï¼ˆæ€»å…± ${a.length} æ¬¡ï¼‰`)):console.log(`[ForNode] å¼€å§‹æ‰§è¡Œå¾ªç¯ï¼Œå…± ${a.length} æ¬¡è¿­ä»£`);let p=[];for(let e=0;e<u.length;e++){let n=d+e,r=u[e]||{};console.log(`[ForNode] æ‰§è¡Œç¬¬ ${n+1}/${a.length} æ¬¡è¿­ä»£`,r);try{let e=await t.executeContainer(i.containerId,r);p.push({index:n,variables:r,result:e,status:`success`})}catch(e){let t=e instanceof Error?e.message:String(e);if(console.error(`[ForNode] ç¬¬ ${n+1} æ¬¡è¿­ä»£å¤±è´¥:`,t),p.push({index:n,variables:r,error:t,status:`error`}),!i.errorHandling?.continueOnError)throw e}}let m=a.length,h=u.length,g=p.filter(e=>e.status===`success`).length,_=p.filter(e=>e.status===`error`).length,v={next:{totalCount:m,executedCount:h,successCount:g,errorCount:_,results:p,pagination:s?{enabled:!0,currentPage:l,pageSize:c,totalPages:Math.ceil(m/c),startIndex:d,endIndex:f-1}:void 0,summary:s?`ç¬¬ ${l} é¡µï¼šæ‰§è¡Œ ${h} æ¬¡ï¼ŒæˆåŠŸ ${g} æ¬¡ï¼Œå¤±è´¥ ${_} æ¬¡`:`å¾ªç¯æ‰§è¡Œ ${h} æ¬¡ï¼ŒæˆåŠŸ ${g} æ¬¡ï¼Œå¤±è´¥ ${_} æ¬¡`}};return this.createOutput(v,{totalCount:m,executedCount:h,successCount:g,errorCount:_},v.next.summary)}catch(e){return this.createError(e)}}getDefaultConfig(){return{mode:`variable`,variable:``,range:{start:0,end:10,step:1},itemName:`item`,indexName:`index`,containerId:null,errorHandling:{continueOnError:!1}}}},Ki=t({HttpRequestNode:()=>qi,JsonParseNode:()=>Ji,ObjectGetNode:()=>Yi}),qi=class extends n{constructor(...e){super(...e),this.type=`http-request`,this.label=`HTTP è¯·æ±‚`,this.description=`å‘é€ HTTP è¯·æ±‚å¹¶è¿”å›å“åº”`,this.category=`ç½‘ç»œ`}defineInputs(){return[{name:`url`,type:`string`,description:`è¯·æ±‚ URL`,required:!0},{name:`method`,type:`string`,description:`è¯·æ±‚æ–¹æ³•ï¼ˆGET/POST/PUT/DELETE/PATCHï¼‰`,defaultValue:`GET`},{name:`headers`,type:`object`,description:`è¯·æ±‚å¤´ï¼ˆJSON å¯¹è±¡ï¼‰`,defaultValue:{}},{name:`body`,type:`any`,description:`è¯·æ±‚ä½“ï¼ˆPOST/PUT/PATCH æ—¶ä½¿ç”¨ï¼‰`},{name:`timeout`,type:`number`,description:`è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰`,defaultValue:3e4}]}defineOutputs(){return[{name:`data`,type:`any`,description:`å“åº”æ•°æ®`},{name:`status`,type:`number`,description:`HTTP çŠ¶æ€ç `},{name:`headers`,type:`object`,description:`å“åº”å¤´`},{name:`success`,type:`boolean`,description:`è¯·æ±‚æ˜¯å¦æˆåŠŸï¼ˆçŠ¶æ€ç  2xxï¼‰`}]}getStyleConfig(){return{headerColor:[`#3b82f6`,`#06b6d4`],icon:`ğŸŒ`,showIcon:!0,bodyStyle:{minWidth:`240px`}}}async execute(e,t){try{let n=this.getInput(e,`url`),r=this.getInput(e,`method`,`GET`),i=this.getInput(e,`headers`,{}),a=this.getInput(e,`body`),o=this.getInput(e,`timeout`,3e4),s=this.validateInputs(e);if(!s.valid)return this.createError(s.errors.join(`; `));if(t.signal?.aborted)return this.createError(`è¯·æ±‚å·²ä¸­æ­¢`);let c={method:r,headers:{"Content-Type":`application/json`,...i},signal:t.signal};[`POST`,`PUT`,`PATCH`].includes(r)&&a!==void 0&&(c.body=typeof a==`string`?a:JSON.stringify(a));let l=new AbortController,u=setTimeout(()=>l.abort(),o);try{let e=await fetch(n,{...c,signal:l.signal});clearTimeout(u);let t,i=e.headers.get(`content-type`);t=i?.includes(`application/json`)?await e.json():i?.includes(`text/`)?await e.text():await e.blob();let a={};e.headers.forEach((e,t)=>{a[t]=e});let o=e.ok;return this.createOutput({data:t,status:e.status,headers:a,success:o},t,`${r} ${n} - ${e.status} ${e.statusText}`)}catch(e){if(clearTimeout(u),e.name===`AbortError`)return this.createError(`è¯·æ±‚è¶…æ—¶`);throw e}}catch(e){return this.createError(e)}}},Ji=class extends n{constructor(...e){super(...e),this.type=`json-parse`,this.label=`JSON è§£æ`,this.description=`å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡`,this.category=`æ•°æ®å¤„ç†`}defineInputs(){return[{name:`json`,type:`string`,description:`JSON å­—ç¬¦ä¸²`,required:!0}]}defineOutputs(){return[{name:`data`,type:`object`,description:`è§£æåçš„å¯¹è±¡`}]}getStyleConfig(){return{headerColor:`#8b5cf6`,icon:`ğŸ“‹`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`json`,``),n=this.validateInputs(e);if(!n.valid)return this.createError(n.errors.join(`; `));let r=JSON.parse(t);return this.createOutput(r,r,`è§£ææˆåŠŸ`)}catch(e){return this.createError(`JSON è§£æå¤±è´¥: ${e.message}`)}}},Yi=class extends n{constructor(...e){super(...e),this.type=`object-get`,this.label=`å¯¹è±¡å–å€¼`,this.description=`ä»å¯¹è±¡ä¸­æå–æŒ‡å®šè·¯å¾„çš„å€¼`,this.category=`æ•°æ®å¤„ç†`}defineInputs(){return[{name:`object`,type:`object`,description:`è¾“å…¥å¯¹è±¡`,required:!0},{name:`path`,type:`string`,description:`å¯¹è±¡è·¯å¾„ï¼ˆå¦‚ "user.name" æˆ– "items[0].id"ï¼‰`,required:!0},{name:`defaultValue`,type:`any`,description:`é»˜è®¤å€¼ï¼ˆè·¯å¾„ä¸å­˜åœ¨æ—¶è¿”å›ï¼‰`}]}defineOutputs(){return[{name:`value`,type:`any`,description:`æå–çš„å€¼`}]}getStyleConfig(){return{headerColor:`#f59e0b`,icon:`ğŸ”‘`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`object`),n=this.getInput(e,`path`,``),r=this.getInput(e,`defaultValue`),i=this.validateInputs(e);if(!i.valid)return this.createError(i.errors.join(`; `));let a=this.getValueByPath(t,n,r);return this.createOutput(a,a,`æå–è·¯å¾„: ${n}`)}catch(e){return this.createError(e)}}getValueByPath(e,t,n){if(!e||!t)return n;let r=t.replace(/\[(\w+)\]/g,`.$1`).split(`.`).filter(e=>e.length>0),i=e;for(let e of r){if(i==null)return n;i=i[e]}return i===void 0?n:i}},Xi=t({NoteNode:()=>Zi}),Zi=class extends n{constructor(...e){super(...e),this.type=`note`,this.label=`ç¬”è®°`,this.description=`åœ¨å·¥ä½œæµä¸­æ·»åŠ æ³¨é‡Šå’Œè¯´æ˜`,this.category=`å·¥å…·`}defineInputs(){return[]}defineOutputs(){return[]}getStyleConfig(){return{headerColor:`#fbbf24`,icon:`ğŸ“`,showIcon:!0}}async execute(e,t){return{success:!0,summary:`ç¬”è®°èŠ‚ç‚¹ï¼ˆè·³è¿‡æ‰§è¡Œï¼‰`,outputs:{}}}},Qi=t({StartNode:()=>$i}),$i=class extends n{constructor(...e){super(...e),this.type=`start`,this.label=`å¼€å§‹`,this.description=`å·¥ä½œæµç¨‹çš„èµ·å§‹èŠ‚ç‚¹`,this.category=`æ§åˆ¶æµ`}defineInputs(){return[]}defineOutputs(){return[{name:`output`,type:`any`,description:`å¼€å§‹ä¿¡å·`}]}getStyleConfig(){return{headerColor:[`#10b981`,`#059669`],showIcon:!0}}async execute(e,t){return console.log(`[StartNode execute]`,t),this.createOutput({output:{started:!0,timestamp:Date.now(),workflowId:t.workflow?.workflowId,datas:{name:`John Doe`,age:30,address:{street:`123 Main St`,city:`Anytown`}},lists:[{name:`John Doe`,age:30},{name:`IXOA Doe`,age:10},{name:`UN NJH Doe`,age:25}],maps:{name:`John Doe`,age:30}}})}},ea=t({TextProcessNode:()=>ta}),ta=class extends n{constructor(...e){super(...e),this.type=`text-process`,this.label=`æ–‡æœ¬å¤„ç†`,this.description=`å¯¹è¾“å…¥æ–‡æœ¬è¿›è¡Œè½¬æ¢å¤„ç†`,this.category=`æ–‡æœ¬å·¥å…·`}defineInputs(){return[{name:`text`,type:`string`,description:`è¾“å…¥æ–‡æœ¬`,required:!0},{name:`mode`,type:`string`,description:`å¤„ç†æ¨¡å¼`,defaultValue:`uppercase`,options:[{label:`å¤§å†™`,value:`uppercase`},{label:`å°å†™`,value:`lowercase`},{label:`åè½¬`,value:`reverse`}]},{name:`prefix`,type:`string`,description:`æ·»åŠ å‰ç¼€`,defaultValue:``}]}defineOutputs(){return[{name:`result`,type:`string`,description:`å¤„ç†åçš„æ–‡æœ¬`},{name:`length`,type:`number`,description:`æ–‡æœ¬é•¿åº¦`}]}getStyleConfig(){return{headerColor:`#3b82f6`,icon:`ğŸ“`,showIcon:!0,bodyStyle:{minWidth:`200px`}}}async execute(e,t){try{let t=this.getInput(e,`text`,``).toString(),n=this.getInput(e,`mode`,`uppercase`),r=this.getInput(e,`prefix`,``),i=this.validateInputs(e);if(!i.valid)return this.createError(i.errors.join(`; `));let a=t;switch(n){case`uppercase`:a=t.toUpperCase();break;case`lowercase`:a=t.toLowerCase();break;case`reverse`:a=t.split(``).reverse().join(``);break}return r&&(a=r+a),this.createOutput({result:a,length:a.length})}catch(e){return this.createError(e)}}};let G={},na={"./nodes/CodeNode.ts":Mi,"./nodes/ConnectorNode.ts":Fi,"./nodes/DataTransformNode.ts":Li,"./nodes/DelayNode.ts":Bi,"./nodes/EndNode.ts":Hi,"./nodes/ForNode.ts":Wi,"./nodes/HttpRequestNode.ts":Ki,"./nodes/IfNode.ts":Di,"./nodes/NoteNode.ts":Xi,"./nodes/StartNode.ts":Qi,"./nodes/TextProcessNode.ts":ea};for(let e in na){let t=na[e];for(let e in t){let n=t[e];if(typeof n==`function`&&n.prototype)try{let e=new n;e&&typeof e.type==`string`&&(G[e.type]=n)}catch{}}}function ra(){return Object.values(G).map(e=>new e().getMetadata())}let K=`[FlowWorker]`,q=null,ia=!1,J={executionId:null,workflowId:null},Y=e=>self.postMessage(e),aa=()=>({executionId:J.executionId??void 0,workflowId:J.workflowId??void 0}),oa=[];function X(){return oa}function sa(e){oa=e.slice(-1e3)}function ca(e,t){try{let n={};e.nodeResults instanceof Map&&e.nodeResults.forEach((e,t)=>{n[t]=e});let r={executionId:e.executionId,workflowId:e.workflowId,success:e.success,startTime:e.startTime,endTime:e.endTime,duration:e.duration,error:e.error,executedNodeCount:e.executedNodeIds.length,skippedNodeCount:e.skippedNodeIds.length,cachedNodeCount:e.cachedNodeIds.length,executedNodeIds:e.executedNodeIds,skippedNodeIds:e.skippedNodeIds,cachedNodeIds:e.cachedNodeIds,nodeResults:n,nodes:t?.nodes,edges:t?.edges},i=X();i.push(r),sa(i),console.log(`${K} å·²ä¿å­˜æ‰§è¡Œå†å²:`,r.executionId)}catch(e){console.error(`${K} æ·»åŠ æ‰§è¡Œå†å²å¤±è´¥:`,e)}}function la(e,t,n){try{let r=X();t&&(r=r.filter(e=>e.workflowId===t)),r.sort((e,t)=>t.startTime-e.startTime),n&&n>0&&(r=r.slice(0,n)),Y({type:`HISTORY_DATA`,payload:{requestId:e,history:r}}),console.log(`${K} å·²è¿”å›å†å²è®°å½•ï¼Œå…± ${r.length} æ¡`,t?`(å·¥ä½œæµ: ${t})`:`(å…¨éƒ¨)`)}catch(e){console.error(`${K} è·å–æ‰§è¡Œå†å²å¤±è´¥:`,e)}}function ua(e){try{if(e){let t=X().filter(t=>t.workflowId!==e);sa(t),console.log(`${K} å·²æ¸…ç©ºå·¥ä½œæµå†å²:`,e)}else oa=[],console.log(`${K} å·²æ¸…ç©ºæ‰€æœ‰æ‰§è¡Œå†å²`)}catch(e){console.error(`${K} æ¸…ç©ºæ‰§è¡Œå†å²å¤±è´¥:`,e)}}function da(e){try{let t=X().filter(t=>t.executionId!==e);sa(t),console.log(`${K} å·²åˆ é™¤æ‰§è¡Œå†å²:`,e)}catch(e){console.error(`${K} åˆ é™¤æ‰§è¡Œå†å²å¤±è´¥:`,e)}}let Z=()=>{if(!J.executionId||!J.workflowId)throw Error(`æ‰§è¡Œä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–`);return{executionId:J.executionId,workflowId:J.workflowId}},Q=e=>{Y({type:`STATE_CHANGE`,payload:{...aa(),state:e}})},$=()=>{J.executionId=null,J.workflowId=null},fa=(e,t,n)=>{let r=Date.now();return{success:!1,executionId:e,workflowId:t,startTime:r,endTime:r,duration:0,nodeResults:new Map,executedNodeIds:[],skippedNodeIds:[],cachedNodeIds:[],strategy:`full`,error:n}},pa=e=>{let t=e.workflowId??J.workflowId??``;return e.result&&e.workflowId?e:{...e,workflowId:t,result:e.result??fa(e.executionId,t,e.error)}},ma=e=>({...e,onExecutionStart:t=>{J.executionId=t.executionId,J.workflowId=t.workflowId,Y({type:`EXECUTION_START`,payload:t}),Q(`running`),e?.onExecutionStart?.(t)},onExecutionComplete:t=>{J.executionId=t.executionId,J.workflowId=t.workflowId,Y({type:`EXECUTION_COMPLETE`,payload:t}),Q(`completed`),e?.onExecutionComplete?.(t),$()},onExecutionError:t=>{let n=pa(t);J.executionId=n.executionId,J.workflowId=n.workflowId,Y({type:`EXECUTION_ERROR`,payload:n}),Q(`error`),e?.onExecutionError?.(n),$()},onNodeStart:t=>{let n=Z();Y({type:`NODE_START`,payload:{...n,nodeId:t}}),e?.onNodeStart?.(t)},onNodeComplete:(t,n)=>{let r=Z();Y({type:`NODE_COMPLETE`,payload:{...r,nodeId:t,result:n}}),e?.onNodeComplete?.(t,n)},onNodeError:(t,n)=>{let r=Z();Y({type:`NODE_ERROR`,payload:{...r,nodeId:t,error:n.message}}),e?.onNodeError?.(t,n)},onProgress:t=>{Y({type:`PROGRESS`,payload:{...aa(),progress:t}}),e?.onProgress?.(t)},onCacheHit:(t,n)=>{let r=Z();Y({type:`CACHE_HIT`,payload:{...r,nodeId:t,cachedResult:n}}),e?.onCacheHit?.(t,n)},onIterationUpdate:(t,n)=>{let r=Z();Y({type:`ITERATION_UPDATE`,payload:{...r,nodeId:t,iterationData:n}}),e?.onIterationUpdate?.(t,n)}}),ha=(e,t,n)=>{let r=t instanceof Error?t.message:String(t),i=J.executionId??`exec_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,a=J.workflowId??e.workflow_id,o=fa(i,a,r),s={executionId:i,workflowId:a,error:r,result:o};ca(o,e),Y({type:`EXECUTION_ERROR`,payload:s}),Q(`error`),n?.onExecutionError?.(s),$()};function ga(){try{console.log(`${K} å¼€å§‹åˆå§‹åŒ–...`,G);let e=y(G);console.log(`${K} å·²åŠ è½½ ${e.getAllTypes().length} ä¸ªèŠ‚ç‚¹ç±»å‹:`,e.getAllTypes()),q=new _(e),ia=!0,Y({type:`INITIALIZED`}),console.log(`${K} åˆå§‹åŒ–å®Œæˆ`)}catch(e){console.error(`${K} åˆå§‹åŒ–å¤±è´¥:`,e);let t={type:`ERROR`,payload:{message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}};Y(t)}}async function _a(e,t){if(!q)throw Error(`æ‰§è¡Œå™¨æœªåˆå§‹åŒ–`);try{console.log(`${K} å¼€å§‹æ‰§è¡Œå·¥ä½œæµ:`,e.workflow_id);let n=ma(t),r=await q.execute(e,n).catch(e=>{throw e});return console.log(`${K} å·¥ä½œæµæ‰§è¡Œå®Œæˆ:`,r),ca(r,e),r}catch(n){console.error(`${K} å·¥ä½œæµæ‰§è¡Œå¤±è´¥:`,n),ha(e,n,t)}}function va(){q&&(q.pause(),Q(`paused`),console.log(`${K} æ‰§è¡Œå·²æš‚åœ`))}function ya(){q&&(q.resume(),Q(`running`),console.log(`${K} æ‰§è¡Œå·²æ¢å¤`))}function ba(){q&&(q.stop(),Q(`cancelled`),$(),console.log(`${K} æ‰§è¡Œå·²åœæ­¢`))}function xa(e,t){if(!q)return;let n=q.getCacheStats(e);Y({type:`CACHE_STATS`,payload:{requestId:t,stats:n}})}function Sa(e){q&&(q.clearCache(e),console.log(`${K} å·²æ¸…ç©ºç¼“å­˜:`,e))}function Ca(){q&&(q.clearAllCache(),console.log(`${K} å·²æ¸…ç©ºæ‰€æœ‰ç¼“å­˜`))}function wa(e){try{let t=ra().map(e=>({type:e.type,label:e.label,description:e.description,category:e.category,icon:e.style?.icon,tags:[],inputs:e.inputs.map(e=>({name:e.name,type:e.type,description:e.description,required:e.required,defaultValue:e.defaultValue,options:e?.options??[]})),outputs:e.outputs.map(e=>({name:e.name,type:e.type,description:e.description}))}));Y({type:`NODE_LIST`,payload:{requestId:e,nodes:t}}),console.log(`${K} å·²è¿”å›èŠ‚ç‚¹åˆ—è¡¨ï¼Œå…± ${t.length} ä¸ªèŠ‚ç‚¹`)}catch(e){console.error(`${K} è·å–èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥:`,e)}}self.addEventListener(`message`,async e=>{let t=e.data;try{switch(t.type){case`INIT`:ga();break;case`EXECUTE`:if(!ia)throw Error(`æ‰§è¡Œå™¨æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆå‘é€ INIT æ¶ˆæ¯`);await _a(t.payload.workflow,t.payload.options);break;case`PAUSE`:va();break;case`RESUME`:ya();break;case`STOP`:ba();break;case`GET_CACHE_STATS`:xa(t.payload.workflowId,t.payload.requestId);break;case`CLEAR_CACHE`:Sa(t.payload.workflowId);break;case`CLEAR_ALL_CACHE`:Ca();break;case`GET_NODE_LIST`:wa(t.payload.requestId);break;case`GET_HISTORY`:la(t.payload.requestId,t.payload.workflowId,t.payload.limit);break;case`CLEAR_HISTORY`:ua(t.payload.workflowId);break;case`DELETE_HISTORY`:da(t.payload.executionId);break;default:console.warn(`${K} æœªçŸ¥æ¶ˆæ¯ç±»å‹:`,t)}}catch(e){console.error(`${K} å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:`,e);let t={type:`ERROR`,payload:{message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}};Y(t)}}),console.log(`${K} VueFlow æ‰§è¡Œ Worker å·²å¯åŠ¨`)})();