(function(){var e=Object.defineProperty,t=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n},n=class{getStyleConfig(){return{}}getInputs(){return this.defineInputs()}getOutputs(){return this.defineOutputs()}getStyle(){return this.getStyleConfig()}getInput(e,t,n){if(e&&Object.prototype.hasOwnProperty.call(e,t))return e[t];let r=this.defineInputs().find(e=>e.name===t);return r&&r.defaultValue!==void 0?r.defaultValue:n}createOutput(e,t,n){let r=this.defineOutputs();if(r.length===1&&!this.isPlainObject(e)){let[i]=r;return{outputs:{[i.name]:e},raw:t??e,summary:n,success:!0}}return{outputs:this.isPlainObject(e)?e:{},raw:t??e,summary:n,success:!0}}createError(e){return{success:!1,error:e instanceof Error?e.message:e,outputs:{}}}validateInputs(e){let t=[],n=this.defineInputs();for(let r of n)if(r.required){let n=e[r.name];(n==null||n===``)&&t.push(`"${r.name}" 是必填项`)}return{valid:t.length===0,errors:t}}getMetadata(){return{type:this.type,label:this.label,description:this.description,category:this.category,inputs:this.defineInputs(),outputs:this.defineOutputs(),style:this.getStyleConfig()}}shouldUseCache(e,t){return!0}getCacheableInputs(e){return e}computeConfigHash(e,t={}){let n=this.getCacheableInputs(e),r={type:this.type,inputs:n};return this.hashObject(r)}hashObject(e){let t=this.stableStringify(e),n=5381;for(let e=0;e<t.length;e++)n=n*33^t.charCodeAt(e);return(n>>>0).toString(16)}stableStringify(e){return e==null?String(e):typeof e==`object`?Array.isArray(e)?`[`+e.map(e=>this.stableStringify(e)).join(`,`)+`]`:`{`+Object.keys(e).sort().map(t=>JSON.stringify(t)+`:`+this.stableStringify(e[t])).join(`,`)+`}`:JSON.stringify(e)}isPlainObject(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}},r=class{constructor(e,t,n,r={}){this.state=`idle`,this.nodeStates=new Map,this.nodeOutputs=new Map,this.startTime=0,this.endTime=0,this.paused=!1,this.cancelled=!1,this.loopVariables=void 0,this.nodeIterationHistories=new Map,this.workflow=e,this.executionId=t,this.workflowCache=n,this.options=r}getExecutionId(){return this.executionId}getWorkflowId(){return this.workflow.workflow_id}getWorkflow(){return this.workflow}getOptions(){return this.options}setState(e){this.state=e}getState(){return this.state}start(){this.state=`running`,this.startTime=Date.now()}complete(){this.state=`completed`,this.endTime=Date.now()}error(){this.state=`error`,this.endTime=Date.now()}pause(){this.paused=!0,this.state=`paused`}resume(){this.paused=!1,this.state=`running`}cancel(){this.cancelled=!0,this.state=`cancelled`,this.endTime=Date.now()}isPaused(){return this.paused}isCancelled(){return this.cancelled}getDuration(){return this.startTime===0?0:(this.endTime||Date.now())-this.startTime}getStartTime(){return this.startTime}getEndTime(){return this.endTime}setNodeState(e,t,n){let r={...this.nodeStates.get(e)||{nodeId:e,status:`pending`},status:t,...n};t===`running`&&!r.startTime&&(r.startTime=Date.now()),(t===`success`||t===`error`||t===`cached`)&&!r.endTime&&(r.endTime=Date.now(),r.startTime&&(r.duration=r.endTime-r.startTime)),this.nodeStates.set(e,r)}getNodeState(e){return this.nodeStates.get(e)}getAllNodeStates(){return new Map(this.nodeStates)}setNodeOutput(e,t){this.nodeOutputs.set(e,t)}getNodeOutput(e){return this.nodeOutputs.get(e)}getNodeInputs(e){let t={},n=this.workflow.edges.filter(t=>t.target===e);for(let e of n){let n=this.nodeOutputs.get(e.source);if(n){let r=e.targetHandle||`default`,i;if(e.sourceHandle&&(i=n[e.sourceHandle]),i===void 0){let e=Object.keys(n).filter(e=>n[e]!==void 0);e.length===1?i=n[e[0]]:n.result===void 0?n.default!==void 0&&(i=n.default):i=n.result}i!=null&&t[r]===void 0&&(t[r]=i)}}return console.log(`[getNodeInputs]`,t),t}setCachedResult(e,t){this.workflowCache.set(e,t)}getCachedResult(e){return this.workflowCache.get(e)??null}clearCache(e){e&&e!==this.workflow.workflow_id||this.workflowCache.clear()}clearAllCache(){this.workflowCache.clear()}getCacheStats(e){e||=this.workflow.workflow_id;let t=this.workflowCache.size,n=this.workflow.nodes.length,r=n>0?t/n:0;return{totalNodes:n,cachedNodes:t,hitRate:r}}hasValidCache(e,t){let n=this.getCachedResult(e);return!n||t&&n.configHash!==t?!1:n.status===`success`}getProgress(){let e=this.workflow.nodes.length;if(e===0)return 1;let t=0;for(let e of this.nodeStates.values())(e.status===`success`||e.status===`error`||e.status===`cached`||e.status===`skipped`)&&t++;return t/e}reset(){this.state=`idle`,this.nodeStates.clear(),this.nodeOutputs.clear(),this.nodeIterationHistories.clear(),this.startTime=0,this.endTime=0,this.paused=!1,this.cancelled=!1}appendIterationResult(e,t){let n=this.nodeIterationHistories.get(e);n||(n={iterations:[],totalIterations:0,currentPage:1},this.nodeIterationHistories.set(e,n)),n.iterations.push(t),n.totalIterations=n.iterations.length;let r=this.nodeStates.get(e);r&&(r.iterationHistory={...n})}getIterationHistory(e){return this.nodeIterationHistories.get(e)}clearIterationHistory(e){this.nodeIterationHistories.delete(e)}clearAllIterationHistories(){this.nodeIterationHistories.clear()}},i=class{extractOutputs(e){let t=e.data;if(!t)return null;if(t.executionResult)return typeof t.executionResult==`object`&&!Array.isArray(t.executionResult)?t.executionResult:{default:t.executionResult};if(t.result?.data?.outputs){let e=t.result.data.outputs,n={};return Object.entries(e).forEach(([e,t])=>{t&&typeof t==`object`&&`value`in t?n[e]=t.value:n[e]=t}),n}return t.result?.data?.raw===void 0?null:{default:t.result.data.raw}}},a=class{constructor(e){this.context=e}extractOutputs(e){return this.context.getNodeOutput(e.id)||null}};function o(e,t,n){let r=new Set,i=[],a=new Map(n.map(e=>[e.id,e])),o=e=>{let n=t.filter(t=>t.target===e);for(let e of n){if(!e.source||r.has(e.source))continue;let t=a.get(e.source);if(!t)continue;let n=t.data?.config?.forNodeId;if(n){if(!a.get(n))continue;r.add(n),i.push(n),o(n);continue}r.add(e.source),i.push(e.source),o(e.source)}};return o(e),i}function s(e,t,n){return e==null?[]:Array.isArray(e)?e.map((e,r)=>{let i=`${t}[${r}]`;n.set(i,e);let a=e!=null&&(Array.isArray(e)||typeof e==`object`);return{id:i,label:`[${r}]`,valueType:l(e),reference:u(i),value:e,children:a?s(e,i,n):[]}}):typeof e==`object`?Object.entries(e).filter(([e])=>e!==`type`).map(([e,r])=>{let i=`${t}.${e}`;n.set(i,r);let a=r!=null&&(Array.isArray(r)||typeof r==`object`);return{id:i,label:e,valueType:l(r),reference:u(i),value:r,children:a?s(r,i,n):[]}}):[]}function c(e,t,n,r){if(t==null)return[];let i=n&&e?`${n}.${e}`:n||e;if(Array.isArray(t))return t.map((e,t)=>{let n=`${i}[${t}]`;r.set(n,e);let a=e!=null&&(Array.isArray(e)||typeof e==`object`);return{id:n,label:`[${t}]`,valueType:l(e),reference:u(n),value:e,children:a?s(e,n,r):[]}});if(typeof t==`object`){let a=Object.entries(t).filter(([e])=>e!==`type`),o=(e,t)=>e.map(([e,n])=>{let i=`${t}.${e}`;r.set(i,n);let a=n!=null&&(Array.isArray(n)||typeof n==`object`);return{id:i,label:e,valueType:l(n),reference:u(i),value:n,children:a?s(n,i,r):[]}});if(!e)return o(a,i);r.set(i,t);let c=o(a,i);return[{id:i,label:e,valueType:`object`,reference:u(i),value:t,children:c,nodeId:n,outputId:e}]}return r.set(i,t),[{id:i,label:e,valueType:l(t),reference:u(i),value:t,children:[],nodeId:n,outputId:e}]}function l(e){return e===null?`null`:e===void 0?`undefined`:Array.isArray(e)?`array`:typeof e}function u(e){return`{{ ${e} }}`}function d(e,t,n,r,a,l){let d=new Map(t.map(e=>[e.id,e])),f=new Map,p=[],m=d.get(e),h=m?.parentNode||m?.data?.parentNode,_=o(e,n,t).reverse(),v=null;if(h){let e=d.get(h);if(e?.type===`forLoopContainer`&&(v=e.data?.config?.forNodeId,!v)){for(let e of t)if(e.type===`for`&&e.data?.config?.containerId===h){v=e.id;break}}}let y=r||new i;if(a&&Object.keys(a).length>0){let e=`全局变量`,t={id:`global-variables`,label:`全局变量`,valueType:`object`,reference:e,value:{},children:[]};Object.entries(a).forEach(([n,r])=>{f.set(`${e}.${n}`,r);let i=c(n,r,e,f);t.children?.push(...i)}),p.push(t)}return _.forEach(e=>{let t=d.get(e);if(!t)return;let n=t.label||t.data?.label||e,r=t.type,i=y.extractOutputs(t);if(r===`for`){let r=t.data?.config||{},i=r.containerId;if(h&&i&&h===i&&v===e){let i={id:e,label:n,valueType:`node`,value:null,children:[],nodeId:e},a=r.itemName||`item`,o=r.indexName||`index`,d,m,h=[],_=!1,v=t.data?.params?.items;if(v!=null){let e=g(v,f);Array.isArray(e)&&(h=e)}l?(d=l[a],m=l[o],_=!0):(d=h.length>0?h[0]:null,m=0);let y=c(a,d,n,f);!_&&y[0]&&(y[0].label=y[0].label+` [示例]`),y[0]&&i.children?.push(y[0]);let b=c(o,m,n,f);!_&&b[0]&&(b[0].label=b[0].label+` [示例]`),b[0]&&i.children?.push(b[0]);let x=`${n}.list`;f.set(x,h);let S={id:x,label:`list`,valueType:`array`,reference:u(x),value:h,children:h.length>0?s(h,x,f):[],nodeId:e,outputId:`list`};i.children?.push(S),p.push(i);return}}if(!i||Object.keys(i).length===0)return;let a={id:e,label:n,valueType:`node`,value:null,children:[],nodeId:e};Object.entries(i).forEach(([e,t])=>{if(t===void 0)return;let r=t;if(r&&typeof r==`object`&&!Array.isArray(r)&&`data`in r){let e=r.data,t=r.isError;e&&typeof e==`object`&&(r={...e,...t===void 0?{}:{isError:t}})}let o=Object.keys(i);o.length===1&&o[0]===`default`?f.set(n,r):(f.set(n,r),f.set(`${n}.${e}`,r));let s=c(e,r,n,f);a.children?.push(...s)}),p.push(a)}),{tree:p.reverse(),map:f}}function f(e,t,n,r,i){let o=new a(t);return d(e,n,r,o,i,t.loopVariables)}function p(e,t){let n=JSON.parse(JSON.stringify(e));return m(n,t)}function m(e,t){if(typeof e==`string`)return g(e,t);if(Array.isArray(e))return e.map(e=>m(e,t));if(e&&typeof e==`object`){let n={};return Object.entries(e).forEach(([e,r])=>{n[e]=m(r,t)}),n}return e}let h=/\{\{\s*\$?([^{}]+?)\s*\}\}/g;function g(e,t){let n=[...e.matchAll(h)];if(n.length===0)return e;let r=n[0];if(!r)return e;if(n.length===1&&e.trim()===r[0]){let n=r[1];if(!n)return e;let i=n.trim(),a=t.get(i);return a===void 0?e:a}let i=e;return n.forEach(([e,n])=>{if(!n)return;let r=n.trim();if(!t.has(r))return;let a=t.get(r),o=typeof a==`string`?a:JSON.stringify(a,null,2);i=i.replace(e,o)}),i}var _=class{constructor(e,t){this.defaultOptions={timeout:6e4,maxRetries:3,useCache:!0,clearCache:!1,log:console.log,error:console.error},this.cacheStore=new Map,this.workflowNodeCounts=new Map,this.nodeResolver=e,t&&(this.defaultOptions={...this.defaultOptions,...t}),this.logger={log:this.defaultOptions.log||console.log,error:this.defaultOptions.error||console.error,warn:console.warn}}async execute(e,t){let n={...this.defaultOptions,...t},i=this.generateExecutionId();for(let t of e.nodes)t.data?.forceCacheUsage&&delete t.data.forceCacheUsage;let a=new r(e,i,this.getWorkflowCache(e.workflow_id));this.currentContext=a,this.workflowNodeCounts.set(e.workflow_id,e.nodes.length),n.clearCache&&a.clearCache();try{this.logger.log(`[WorkflowExecutor] 开始执行工作流: ${e.workflow_id}, 执行ID: ${i}`),this.logger.log(`[WorkflowExecutor] 工作流配置: 节点数=${e.nodes.length}, 边数=${e.edges.length}, 选中节点数=${e.selectedNodeIds?.length||0}`),a.start(),n.onProgress?.(0),this.emitExecutionStart(n,{executionId:i,workflowId:e.workflow_id});let t=this.determineStrategy(e);this.logger.log(`[WorkflowExecutor] 执行策略: ${t}`);let r=this.determineNodesToExecute(e,t);this.logger.log(`[WorkflowExecutor] 需要执行的节点数量: ${r.size}`);let o=this.identifyContainerNodes(e.nodes),s=new Set;for(let t of e.nodes){let e=t.parentNode||t.data?.parentNode;e&&typeof e==`string`&&s.add(t.id)}let c=e.nodes.filter(e=>!o.has(e.id)&&!s.has(e.id)),l=e.edges.filter(e=>{let t=!o.has(e.source)&&!s.has(e.source),n=!o.has(e.target)&&!s.has(e.target);return t&&n});this.logger.log(`[WorkflowExecutor] 排除 ${o.size} 个容器节点和 ${s.size} 个子节点后，对 ${c.length} 个顶层节点进行拓扑排序`);let u=this.topologicalSort(c,l);this.logger.log(`[WorkflowExecutor] 拓扑排序完成，执行顺序: ${u.map(e=>e.id).join(` -> `)}`);let d=u.filter(e=>r.has(e.id));this.logger.log(`[WorkflowExecutor] 最终执行顺序: ${d.map(e=>e.id).join(` -> `)}`);for(let t of e.nodes){let e=r.has(t.id)?`pending`:`skipped`;a.setNodeState(t.id,e),e===`skipped`&&(this.logger.log(`[WorkflowExecutor] 跳过节点: ${t.id} (未选中执行)`),n.onNodeSkipped?.(t.id,`not-selected`))}this.logger.log(`[WorkflowExecutor] 开始按顺序执行 ${d.length} 个节点`);for(let e of d){if(this.logger.log(`[WorkflowExecutor] 准备执行节点: ${e.id} (${e.data?.nodeType||e.type})`),a.isPaused()&&(this.logger.log(`[WorkflowExecutor] 执行已暂停，等待恢复...`),await this.waitForResume(a),this.logger.log(`[WorkflowExecutor] 执行已恢复`)),a.isCancelled()){this.logger.log(`[WorkflowExecutor] 执行已取消，停止后续节点执行`);break}await this.executeNode(e,a,n);let t=a.getProgress();this.logger.log(`[WorkflowExecutor] 节点 ${e.id} 执行完成，当前进度: ${t}%`),n.onProgress?.(t)}a.complete(),this.logger.log(`[WorkflowExecutor] 工作流执行完成，执行ID: ${i}`);let f=this.buildExecutionResult(a,t);return this.logger.log(`[WorkflowExecutor] 执行结果: 成功=${f.success}, 执行节点数=${f.executedNodeIds.length}, 跳过节点数=${f.skippedNodeIds.length}, 缓存节点数=${f.cachedNodeIds.length}`),this.emitExecutionComplete(n,f),f}catch(t){a.error();let r=t instanceof Error?t.message:String(t);this.logger.error(`[WorkflowExecutor] 工作流执行失败，执行ID: ${i}, 错误: ${r}`),this.logger.error(t);let o=this.determineStrategy(e),s=this.buildExecutionResult(a,o,r);return this.emitExecutionError(n,{executionId:i,workflowId:e.workflow_id,error:r,result:s}),s}}pause(){this.currentContext?.pause()}resume(){this.currentContext?.resume()}stop(){this.currentContext?.cancel()}getState(){return this.currentContext?.getState()||`idle`}getCachedResult(e,t){return this.cacheStore.get(e)?.get(t)??null}clearCache(e){this.cacheStore.get(e)?.clear(),this.workflowNodeCounts.delete(e)}clearAllCache(){this.cacheStore.clear(),this.workflowNodeCounts.clear()}getCacheStats(e){let t=this.cacheStore.get(e),n=t?t.size:0,r=this.workflowNodeCounts.get(e)??0,i=r>0?n/r:0;return{totalNodes:r,cachedNodes:n,hitRate:i}}determineStrategy(e){let t=e.selectedNodeIds;return!t||t.length===0?`full`:t.length===1?`single`:`selective`}determineNodesToExecute(e,t){let n=new Set;if(t===`full`)return this.findReachableNodesFromStart(e.nodes,e.edges);let r=e.selectedNodeIds||[];for(let t of r)n.add(t),this.findDependencies(t,e.nodes,e.edges).forEach(e=>n.add(e));return n}findReachableNodesFromStart(e,t){let n=e.filter(e=>e.data?.nodeType===`start`||e.type===`start`);if(n.length===0)return this.logger.warn(`[WorkflowExecutor] 工作流中没有找到开始节点，将不执行任何节点`),new Set;n.length>1&&this.logger.warn(`[WorkflowExecutor] 工作流中发现多个开始节点（${n.length}个），将从所有开始节点出发`);let r=new Set,i=n.map(e=>e.id);for(n.forEach(e=>r.add(e.id));i.length>0;){let e=i.shift(),n=t.filter(t=>t.source===e);for(let e of n)r.has(e.target)||(r.add(e.target),i.push(e.target))}let a=e.filter(e=>e.data?.isExecutionStart===!0);if(a.length>0){this.logger.log(`[WorkflowExecutor] 发现 ${a.length} 个标记的执行起点`);for(let n of a){let r=this.findDependencies(n.id,e,t);for(let t of r){let r=e.find(e=>e.id===t);r&&(r.data||={},r.data.forceCacheUsage=!0,this.logger.log(`[WorkflowExecutor] 节点 ${t} 标记为强制使用缓存（${n.id} 的前置依赖）`))}}}return this.logger.log(`[WorkflowExecutor] 从开始节点出发，找到 ${r.size} 个可达节点`),r}findDependencies(e,t,n){let r=new Set,i=new Set,a=e=>{if(i.has(e))return;i.add(e);let t=n.filter(t=>t.target===e);for(let e of t)r.add(e.source),a(e.source)};return a(e),r}shouldSkipNodeDueToInvalidInputs(e,t){let n=t.getWorkflow(),r=n.edges.filter(t=>t.target===e);if(r.length===0)return!1;let i=!1,a=!1,o=!1,s=!1;for(let e of r){let r=n.nodes.find(t=>t.id===e.source);if(!r)continue;let c=r.data?.nodeType||r.type;if(c===`forLoopContainer`){i=!0;break}let l=t.getNodeOutput(e.source);if(!l)continue;let u=e.sourceHandle||`default`,d=l[u];c===`if`?(a=!0,d!=null&&(o=!0)):(d??l)!=null&&(s=!0)}return i?!1:a?!o&&r.length===1:!s}topologicalSort(e,t){let n=new Map,r=new Map;for(let t of e)n.set(t.id,[]),r.set(t.id,0);for(let e of t)n.get(e.source)?.push(e.target),r.set(e.target,(r.get(e.target)||0)+1);let i=[],a=[];for(let[e,t]of r.entries())t===0&&i.push(e);for(;i.length>0;){let e=i.shift();a.push(e);let t=n.get(e)||[];for(let e of t){let t=(r.get(e)||0)-1;r.set(e,t),t===0&&i.push(e)}}if(a.length!==e.length){let t=Error(`工作流中存在循环依赖`);throw this.logger.error(`[WorkflowExecutor] 拓扑排序失败: ${t.message}`),this.logger.error(`[WorkflowExecutor] 节点总数: ${e.length}, 排序后: ${a.length}`),this.logger.error(`[WorkflowExecutor] 未排序的节点: ${e.filter(e=>!a.includes(e.id)).map(e=>e.id).join(`, `)}`),t}return a.map(t=>e.find(e=>e.id===t))}async executeNode(e,t,n){let r=e.id;try{let i=e.data?.nodeType||e.type;if(this.shouldSkipNodeDueToInvalidInputs(r,t)){this.logger.log(`[WorkflowExecutor] 跳过节点 ${r}: 所有输入端口都没有有效数据`),t.setNodeState(r,`skipped`),n.onNodeSkipped?.(r,`no-valid-input`);return}let a=t.getNodeInputs(r);if(this.logger.log(`[WorkflowExecutor] 节点 ${r} (${i}) 初始输入:`,{inputs:Object.keys(a),hasParams:!!e.data?.params}),e.data?.params){this.logger.log(`[WorkflowExecutor] 节点 ${r} 的 params:`,e.data.params);let{map:i}=f(r,t,t.getWorkflow().nodes,t.getWorkflow().edges,n.globalVariables);this.logger.log(`[WorkflowExecutor] 节点 ${r} 变量上下文包含 ${i.size} 个变量`);let o=p(e.data.params,i);this.logger.log(`[WorkflowExecutor] 节点 ${r} 解析后的 params:`,o),Object.assign(a,o),this.logger.log(`[WorkflowExecutor] 节点 ${r} 合并后的 inputs:`,Object.keys(a))}let o=!1,s,c=e.data?.forceCacheUsage===!0;if(c&&this.logger.log(`[WorkflowExecutor] 节点 ${r} 被标记为强制使用缓存（执行起点的前置依赖）`),n.useCache||c){this.logger.log(`[WorkflowExecutor] 节点 ${r} 缓存功能已启用`);let l=this.nodeResolver.resolveInstance(i);if(o=c||l.shouldUseCache(a,{nodeId:r,workflowId:t.getWorkflowId()}),this.logger.log(`[WorkflowExecutor] 节点 ${r} 缓存判断结果: ${o}`),o)if(s=l.computeConfigHash(a,e.data||{}),this.logger.log(`[WorkflowExecutor] 节点 ${r} 配置哈希: ${s}`),t.hasValidCache(r,s)){this.logger.log(`[WorkflowExecutor] 节点 ${r} 使用缓存结果`);let e=t.getCachedResult(r);t.setNodeState(r,`cached`,{outputs:e.outputs,fromCache:!0,duration:e.duration,inputs:e.inputs}),t.setNodeOutput(r,e.outputs),n.onCacheHit?.(r,e);return}else this.logger.log(`[WorkflowExecutor] 节点 ${r} 无有效缓存，将重新执行`)}else this.logger.log(`[WorkflowExecutor] 节点 ${r} 缓存功能已禁用`);this.logger.log(`[WorkflowExecutor] 开始执行节点 ${r} (${i})`),t.setNodeState(r,`running`),n.onNodeStart?.(r);let l=this.nodeResolver.resolve(i),u={nodeId:r,nodeData:e.data,workflowId:t.getWorkflowId()};i===`for`&&(u.executeContainer=async(e,r)=>await this.executeContainerNodes(e,r,t,n)),this.logger.log(`[WorkflowExecutor] 正在调用节点 ${r} 的执行函数`);let d=await this.executeWithTimeout(()=>l(a,u),n.timeout);if(this.logger.log(`[WorkflowExecutor] 节点 ${r} 执行函数调用完成`),d&&typeof d==`object`&&`success`in d&&d.success===!1){let e=d.error||`节点执行失败`;throw this.logger.error(`[WorkflowExecutor] 节点 ${r} 执行失败: ${e}`),Error(e)}let m=d?.outputs??{};if(this.logger.log(`[WorkflowExecutor] 节点 ${r} 输出数据:`,{outputKeys:Object.keys(m),hasOutput:Object.keys(m).length>0}),t.setNodeOutput(r,m),t.setNodeState(r,`success`,{outputs:m,inputs:a}),o&&s){this.logger.log(`[WorkflowExecutor] 缓存节点 ${r} 的执行结果`);let e=t.getNodeState(r);t.setCachedResult(r,{nodeId:r,status:`success`,timestamp:Date.now(),outputs:m,inputs:a,duration:e.duration||0,configHash:s})}this.logger.log(`[WorkflowExecutor] 节点 ${r} 执行成功完成`),n.onNodeComplete?.(r,m)}catch(e){let i=e instanceof Error?e.message:String(e);throw this.logger.error(`[WorkflowExecutor] 节点 ${r} 执行失败: ${i}`),this.logger.error(e),t.setNodeState(r,`error`,{error:i}),n.onNodeError?.(r,e instanceof Error?e:Error(i)),e}}async executeWithTimeout(e,t=6e4){return this.logger.log(`[WorkflowExecutor] 设置执行超时: ${t}ms`),new Promise((n,r)=>{let i=setTimeout(()=>{let e=Error(`执行超时`);this.logger.error(`[WorkflowExecutor] 执行超时: ${t}ms`),r(e)},t);e().then(e=>{clearTimeout(i),this.logger.log(`[WorkflowExecutor] 执行在超时前完成`),n(e)}).catch(e=>{clearTimeout(i),this.logger.error(`[WorkflowExecutor] 执行过程中发生错误:`,e),r(e)})})}async waitForResume(e){return new Promise(t=>{let n=setInterval(()=>{e.isPaused()||(clearInterval(n),t())},100)})}buildExecutionResult(e,t,n){let r=e.getAllNodeStates(),i=[],a=[],o=[];for(let[e,t]of r.entries())t.status===`success`||t.status===`running`||t.status===`error`?i.push(e):t.status===`skipped`?a.push(e):t.status===`cached`&&o.push(e);return{success:e.getState()===`completed`&&!n,executionId:e.getExecutionId(),workflowId:e.getWorkflowId(),startTime:e.getStartTime(),endTime:e.getEndTime(),duration:e.getDuration(),nodeResults:r,executedNodeIds:i,skippedNodeIds:a,cachedNodeIds:o,strategy:t,error:n}}generateExecutionId(){return`exec_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}getWorkflowCache(e){return this.cacheStore.has(e)||this.cacheStore.set(e,new Map),this.cacheStore.get(e)}emitExecutionStart(e,t){e.onExecutionStart?.(t)}emitExecutionComplete(e,t){e.onExecutionComplete?.(t)}emitExecutionError(e,t){e.onExecutionError?.(t)}identifyContainerNodes(e){let t=new Set;for(let n of e){let e=n.parentNode||n.data?.parentNode;e&&typeof e==`string`&&(t.add(e),this.logger.log(`[WorkflowExecutor] 节点 ${n.id} 的父节点是 ${e}（容器节点）`))}return this.logger.log(`[WorkflowExecutor] 识别到 ${t.size} 个容器节点:`,Array.from(t)),t}async executeContainerNodes(e,t,n,r){let i=n.getWorkflow(),a=i.nodes.filter(t=>t.id!==e&&(t.data?.parentNode===e||t.parentNode===e));if(a.length===0)return this.logger.warn(`[WorkflowExecutor] 容器 ${e} 内没有找到任何节点`),null;let o=t.index??0;if(this.logger.log(`[WorkflowExecutor] 容器 ${e} 第 ${o+1} 次迭代，内有 ${a.length} 个节点`),o===0){this.logger.log(`[WorkflowExecutor] 清空容器 ${e} 内 ${a.length} 个节点的迭代历史`);for(let e of a)n.clearIterationHistory(e.id)}for(let e of a)n.setNodeState(e.id,`pending`);let s=new Set(a.map(e=>e.id)),c=i.edges.filter(t=>s.has(t.source)&&s.has(t.target)&&t.source!==e&&t.target!==e);this.logger.log(`[WorkflowExecutor] 容器内有 ${c.length} 条边`);let l=this.topologicalSort(a,c);this.logger.log(`[WorkflowExecutor] 容器内节点执行顺序: ${l.map(e=>e.id).join(` -> `)}`),n.loopVariables=t,this.logger.log(`[WorkflowExecutor] 注入迭代变量:`,Object.keys(t));let u=null;this.logger.log(`[WorkflowExecutor] 开始执行容器 ${e} 内的节点`);for(let e of l){if(this.logger.log(`[WorkflowExecutor] 容器内执行节点: ${e.id}`),n.isCancelled()){this.logger.log(`[WorkflowExecutor] 容器执行已取消`);break}await this.executeNode(e,n,r);let i=n.getNodeOutput(e.id),a=n.getNodeState(e.id);if(a){let s={iterationIndex:o,iterationVars:t,executionResult:i||null,executionStatus:a.status,executionDuration:a.duration,executionTimestamp:Date.now(),executionError:a.error};n.appendIterationResult(e.id,s),r.onIterationUpdate?.(e.id,s),this.logger.log(`[WorkflowExecutor] 保存节点 ${e.id} 第 ${o+1} 次迭代结果:`,{status:a.status,hasOutput:!!i,duration:a.duration})}i&&(u=i)}return n.loopVariables=void 0,this.logger.log(`[WorkflowExecutor] 容器 ${e} 执行完成，恢复原始上下文`),u}},v=class{constructor(e){this.metadataCache=new Map,this.registry=e}getNodeClass(e){let t=this.registry[e];if(!t)throw Error(`未知的节点类型: ${e}`);return t}resolveInstance(e){return new(this.getNodeClass(e))}resolve(e){let t=this.getNodeClass(e);return async(e,n)=>await new t().execute(e,n)}getMetadata(e){if(this.metadataCache.has(e))return this.metadataCache.get(e);let t=new(this.getNodeClass(e)),n=t.getMetadata(),r={type:t.type,label:n.label,description:n.description,inputs:t.getInputs().map(e=>({name:e.name,label:e.description||e.name,type:e.type||`any`,required:e.required})),outputs:t.getOutputs().map(e=>({name:e.name,label:e.description||e.name,type:e.type||`any`})),category:n.category,icon:n.style?.icon};return this.metadataCache.set(e,r),r}getCode(e){try{return new(this.getNodeClass(e))().execute.toString()}catch(t){console.error(`获取节点代码失败 [${e}]:`,t);return}}hasNode(e){return e in this.registry}getAllTypes(){return Object.keys(this.registry)}clearCache(){this.metadataCache.clear()}};function y(e){return new v(e)}var b=typeof global==`object`&&global&&global.Object===Object&&global,x=typeof self==`object`&&self&&self.Object===Object&&self,S=b||x||Function(`return this`)(),C=S.Symbol,ee=Object.prototype,te=ee.hasOwnProperty,ne=ee.toString,w=C?C.toStringTag:void 0;function re(e){var t=te.call(e,w),n=e[w];try{e[w]=void 0;var r=!0}catch{}var i=ne.call(e);return r&&(t?e[w]=n:delete e[w]),i}var ie=re,ae=Object.prototype.toString;function oe(e){return ae.call(e)}var se=oe,ce=`[object Null]`,le=`[object Undefined]`,ue=C?C.toStringTag:void 0;function de(e){return e==null?e===void 0?le:ce:ue&&ue in Object(e)?ie(e):se(e)}var T=de;function fe(e){return typeof e==`object`&&!!e}var E=fe,D=Array.isArray;function pe(e){var t=typeof e;return e!=null&&(t==`object`||t==`function`)}var me=pe,he=`[object AsyncFunction]`,ge=`[object Function]`,_e=`[object GeneratorFunction]`,ve=`[object Proxy]`;function ye(e){if(!me(e))return!1;var t=T(e);return t==ge||t==_e||t==he||t==ve}var be=ye,xe=S[`__core-js_shared__`],Se=function(){var e=/[^.]+$/.exec(xe&&xe.keys&&xe.keys.IE_PROTO||``);return e?`Symbol(src)_1.`+e:``}();function Ce(e){return!!Se&&Se in e}var we=Ce,Te=Function.prototype.toString;function Ee(e){if(e!=null){try{return Te.call(e)}catch{}try{return e+``}catch{}}return``}var O=Ee,De=/[\\^$.*+?()[\]{}|]/g,Oe=/^\[object .+?Constructor\]$/,ke=Function.prototype,Ae=Object.prototype,je=ke.toString,Me=Ae.hasOwnProperty,Ne=RegExp(`^`+je.call(Me).replace(De,`\\$&`).replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,`$1.*?`)+`$`);function Pe(e){return!me(e)||we(e)?!1:(be(e)?Ne:Oe).test(O(e))}var Fe=Pe;function Ie(e,t){return e?.[t]}var Le=Ie;function Re(e,t){var n=Le(e,t);return Fe(n)?n:void 0}var k=Re,ze=k(S,`WeakMap`),Be=9007199254740991,Ve=/^(?:0|[1-9]\d*)$/;function He(e,t){var n=typeof e;return t??=Be,!!t&&(n==`number`||n!=`symbol`&&Ve.test(e))&&e>-1&&e%1==0&&e<t}var Ue=He;function We(e,t){return e===t||e!==e&&t!==t}var Ge=We,Ke=9007199254740991;function qe(e){return typeof e==`number`&&e>-1&&e%1==0&&e<=Ke}var Je=qe;function Ye(e){return e!=null&&Je(e.length)&&!be(e)}var Xe=Ye,Ze=Object.prototype;function Qe(e){var t=e&&e.constructor,n=typeof t==`function`&&t.prototype||Ze;return e===n}var $e=Qe;function et(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}var tt=et,nt=`[object Arguments]`;function rt(e){return E(e)&&T(e)==nt}var it=rt,at=Object.prototype,ot=at.hasOwnProperty,st=at.propertyIsEnumerable,ct=it(function(){return arguments}())?it:function(e){return E(e)&&ot.call(e,`callee`)&&!st.call(e,`callee`)};function lt(){return!1}var ut=lt,dt=typeof exports==`object`&&exports&&!exports.nodeType&&exports,ft=dt&&typeof module==`object`&&module&&!module.nodeType&&module,pt=ft&&ft.exports===dt?S.Buffer:void 0,mt=(pt?pt.isBuffer:void 0)||ut,ht=`[object Arguments]`,gt=`[object Array]`,_t=`[object Boolean]`,vt=`[object Date]`,yt=`[object Error]`,bt=`[object Function]`,xt=`[object Map]`,St=`[object Number]`,Ct=`[object Object]`,wt=`[object RegExp]`,Tt=`[object Set]`,Et=`[object String]`,Dt=`[object WeakMap]`,Ot=`[object ArrayBuffer]`,kt=`[object DataView]`,At=`[object Float32Array]`,jt=`[object Float64Array]`,Mt=`[object Int8Array]`,Nt=`[object Int16Array]`,Pt=`[object Int32Array]`,Ft=`[object Uint8Array]`,It=`[object Uint8ClampedArray]`,Lt=`[object Uint16Array]`,Rt=`[object Uint32Array]`,A={};A[At]=A[jt]=A[Mt]=A[Nt]=A[Pt]=A[Ft]=A[It]=A[Lt]=A[Rt]=!0,A[ht]=A[gt]=A[Ot]=A[_t]=A[kt]=A[vt]=A[yt]=A[bt]=A[xt]=A[St]=A[Ct]=A[wt]=A[Tt]=A[Et]=A[Dt]=!1;function zt(e){return E(e)&&Je(e.length)&&!!A[T(e)]}var Bt=zt;function Vt(e){return function(t){return e(t)}}var Ht=Vt,Ut=typeof exports==`object`&&exports&&!exports.nodeType&&exports,j=Ut&&typeof module==`object`&&module&&!module.nodeType&&module,Wt=j&&j.exports===Ut&&b.process,Gt=function(){try{return j&&j.require&&j.require(`util`).types||Wt&&Wt.binding&&Wt.binding(`util`)}catch{}}(),Kt=Gt&&Gt.isTypedArray,qt=Kt?Ht(Kt):Bt,Jt=Object.prototype.hasOwnProperty;function Yt(e,t){var n=D(e),r=!n&&ct(e),i=!n&&!r&&mt(e),a=!n&&!r&&!i&&qt(e),o=n||r||i||a,s=o?tt(e.length,String):[],c=s.length;for(var l in e)(t||Jt.call(e,l))&&!(o&&(l==`length`||i&&(l==`offset`||l==`parent`)||a&&(l==`buffer`||l==`byteLength`||l==`byteOffset`)||Ue(l,c)))&&s.push(l);return s}var Xt=Yt;function Zt(e,t){return function(n){return e(t(n))}}var Qt=Zt(Object.keys,Object),$t=Object.prototype.hasOwnProperty;function en(e){if(!$e(e))return Qt(e);var t=[];for(var n in Object(e))$t.call(e,n)&&n!=`constructor`&&t.push(n);return t}var tn=en;function nn(e){return Xe(e)?Xt(e):tn(e)}var rn=nn,M=k(Object,`create`);function an(){this.__data__=M?M(null):{},this.size=0}var on=an;function sn(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var cn=sn,ln=`__lodash_hash_undefined__`,un=Object.prototype.hasOwnProperty;function dn(e){var t=this.__data__;if(M){var n=t[e];return n===ln?void 0:n}return un.call(t,e)?t[e]:void 0}var fn=dn,pn=Object.prototype.hasOwnProperty;function mn(e){var t=this.__data__;return M?t[e]!==void 0:pn.call(t,e)}var hn=mn,gn=`__lodash_hash_undefined__`;function _n(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=M&&t===void 0?gn:t,this}var vn=_n;function N(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}N.prototype.clear=on,N.prototype.delete=cn,N.prototype.get=fn,N.prototype.has=hn,N.prototype.set=vn;var yn=N;function bn(){this.__data__=[],this.size=0}var xn=bn;function Sn(e,t){for(var n=e.length;n--;)if(Ge(e[n][0],t))return n;return-1}var P=Sn,Cn=Array.prototype.splice;function wn(e){var t=this.__data__,n=P(t,e);if(n<0)return!1;var r=t.length-1;return n==r?t.pop():Cn.call(t,n,1),--this.size,!0}var Tn=wn;function En(e){var t=this.__data__,n=P(t,e);return n<0?void 0:t[n][1]}var Dn=En;function On(e){return P(this.__data__,e)>-1}var kn=On;function An(e,t){var n=this.__data__,r=P(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this}var jn=An;function F(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}F.prototype.clear=xn,F.prototype.delete=Tn,F.prototype.get=Dn,F.prototype.has=kn,F.prototype.set=jn;var I=F,L=k(S,`Map`);function Mn(){this.size=0,this.__data__={hash:new yn,map:new(L||I),string:new yn}}var Nn=Mn;function Pn(e){var t=typeof e;return t==`string`||t==`number`||t==`symbol`||t==`boolean`?e!==`__proto__`:e===null}var Fn=Pn;function In(e,t){var n=e.__data__;return Fn(t)?n[typeof t==`string`?`string`:`hash`]:n.map}var R=In;function Ln(e){var t=R(this,e).delete(e);return this.size-=t?1:0,t}var Rn=Ln;function zn(e){return R(this,e).get(e)}var Bn=zn;function Vn(e){return R(this,e).has(e)}var Hn=Vn;function Un(e,t){var n=R(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this}var Wn=Un;function z(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}z.prototype.clear=Nn,z.prototype.delete=Rn,z.prototype.get=Bn,z.prototype.has=Hn,z.prototype.set=Wn;var Gn=z;function Kn(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}var qn=Kn;function Jn(){this.__data__=new I,this.size=0}var Yn=Jn;function Xn(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}var Zn=Xn;function Qn(e){return this.__data__.get(e)}var $n=Qn;function er(e){return this.__data__.has(e)}var tr=er,nr=200;function rr(e,t){var n=this.__data__;if(n instanceof I){var r=n.__data__;if(!L||r.length<nr-1)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new Gn(r)}return n.set(e,t),this.size=n.size,this}var ir=rr;function B(e){this.size=(this.__data__=new I(e)).size}B.prototype.clear=Yn,B.prototype.delete=Zn,B.prototype.get=$n,B.prototype.has=tr,B.prototype.set=ir;var ar=B;function or(e,t){for(var n=-1,r=e==null?0:e.length,i=0,a=[];++n<r;){var o=e[n];t(o,n,e)&&(a[i++]=o)}return a}var sr=or;function cr(){return[]}var lr=cr,ur=Object.prototype.propertyIsEnumerable,dr=Object.getOwnPropertySymbols,fr=dr?function(e){return e==null?[]:(e=Object(e),sr(dr(e),function(t){return ur.call(e,t)}))}:lr;function pr(e,t,n){var r=t(e);return D(e)?r:qn(r,n(e))}var mr=pr;function hr(e){return mr(e,rn,fr)}var gr=hr,_r=k(S,`DataView`),vr=k(S,`Promise`),yr=k(S,`Set`),br=`[object Map]`,xr=`[object Object]`,Sr=`[object Promise]`,Cr=`[object Set]`,wr=`[object WeakMap]`,Tr=`[object DataView]`,Er=O(_r),Dr=O(L),Or=O(vr),kr=O(yr),Ar=O(ze),V=T;(_r&&V(new _r(new ArrayBuffer(1)))!=Tr||L&&V(new L)!=br||vr&&V(vr.resolve())!=Sr||yr&&V(new yr)!=Cr||ze&&V(new ze)!=wr)&&(V=function(e){var t=T(e),n=t==xr?e.constructor:void 0,r=n?O(n):``;if(r)switch(r){case Er:return Tr;case Dr:return br;case Or:return Sr;case kr:return Cr;case Ar:return wr}return t});var jr=V,Mr=S.Uint8Array,Nr=`__lodash_hash_undefined__`;function Pr(e){return this.__data__.set(e,Nr),this}var Fr=Pr;function Ir(e){return this.__data__.has(e)}var Lr=Ir;function H(e){var t=-1,n=e==null?0:e.length;for(this.__data__=new Gn;++t<n;)this.add(e[t])}H.prototype.add=H.prototype.push=Fr,H.prototype.has=Lr;var Rr=H;function zr(e,t){for(var n=-1,r=e==null?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}var Br=zr;function Vr(e,t){return e.has(t)}var Hr=Vr,Ur=1,Wr=2;function Gr(e,t,n,r,i,a){var o=n&Ur,s=e.length,c=t.length;if(s!=c&&!(o&&c>s))return!1;var l=a.get(e),u=a.get(t);if(l&&u)return l==t&&u==e;var d=-1,f=!0,p=n&Wr?new Rr:void 0;for(a.set(e,t),a.set(t,e);++d<s;){var m=e[d],h=t[d];if(r)var g=o?r(h,m,d,t,e,a):r(m,h,d,e,t,a);if(g!==void 0){if(g)continue;f=!1;break}if(p){if(!Br(t,function(e,t){if(!Hr(p,t)&&(m===e||i(m,e,n,r,a)))return p.push(t)})){f=!1;break}}else if(!(m===h||i(m,h,n,r,a))){f=!1;break}}return a.delete(e),a.delete(t),f}var Kr=Gr;function qr(e){var t=-1,n=Array(e.size);return e.forEach(function(e,r){n[++t]=[r,e]}),n}var Jr=qr;function Yr(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n}var Xr=Yr,Zr=1,Qr=2,$r=`[object Boolean]`,ei=`[object Date]`,ti=`[object Error]`,ni=`[object Map]`,ri=`[object Number]`,ii=`[object RegExp]`,ai=`[object Set]`,oi=`[object String]`,si=`[object Symbol]`,ci=`[object ArrayBuffer]`,li=`[object DataView]`,ui=C?C.prototype:void 0,di=ui?ui.valueOf:void 0;function fi(e,t,n,r,i,a,o){switch(n){case li:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case ci:return!(e.byteLength!=t.byteLength||!a(new Mr(e),new Mr(t)));case $r:case ei:case ri:return Ge(+e,+t);case ti:return e.name==t.name&&e.message==t.message;case ii:case oi:return e==t+``;case ni:var s=Jr;case ai:var c=r&Zr;if(s||=Xr,e.size!=t.size&&!c)return!1;var l=o.get(e);if(l)return l==t;r|=Qr,o.set(e,t);var u=Kr(s(e),s(t),r,i,a,o);return o.delete(e),u;case si:if(di)return di.call(e)==di.call(t)}return!1}var pi=fi,mi=1,hi=Object.prototype.hasOwnProperty;function gi(e,t,n,r,i,a){var o=n&mi,s=gr(e),c=s.length,l=gr(t).length;if(c!=l&&!o)return!1;for(var u=c;u--;){var d=s[u];if(!(o?d in t:hi.call(t,d)))return!1}var f=a.get(e),p=a.get(t);if(f&&p)return f==t&&p==e;var m=!0;a.set(e,t),a.set(t,e);for(var h=o;++u<c;){d=s[u];var g=e[d],_=t[d];if(r)var v=o?r(_,g,d,t,e,a):r(g,_,d,e,t,a);if(!(v===void 0?g===_||i(g,_,n,r,a):v)){m=!1;break}h||=d==`constructor`}if(m&&!h){var y=e.constructor,b=t.constructor;y!=b&&`constructor`in e&&`constructor`in t&&!(typeof y==`function`&&y instanceof y&&typeof b==`function`&&b instanceof b)&&(m=!1)}return a.delete(e),a.delete(t),m}var _i=gi,vi=1,yi=`[object Arguments]`,bi=`[object Array]`,U=`[object Object]`,xi=Object.prototype.hasOwnProperty;function Si(e,t,n,r,i,a){var o=D(e),s=D(t),c=o?bi:jr(e),l=s?bi:jr(t);c=c==yi?U:c,l=l==yi?U:l;var u=c==U,d=l==U,f=c==l;if(f&&mt(e)){if(!mt(t))return!1;o=!0,u=!1}if(f&&!u)return a||=new ar,o||qt(e)?Kr(e,t,n,r,i,a):pi(e,t,c,n,r,i,a);if(!(n&vi)){var p=u&&xi.call(e,`__wrapped__`),m=d&&xi.call(t,`__wrapped__`);if(p||m){var h=p?e.value():e,g=m?t.value():t;return a||=new ar,i(h,g,n,r,a)}}return f?(a||=new ar,_i(e,t,n,r,i,a)):!1}var Ci=Si;function wi(e,t,n,r,i){return e===t?!0:e==null||t==null||!E(e)&&!E(t)?e!==e&&t!==t:Ci(e,t,n,r,wi,i)}var Ti=wi;function Ei(e,t){return Ti(e,t)}var Di=Ei,Oi=t({DATA_TYPE_LABELS:()=>Ai,IfNode:()=>Mi,OPERATORS_BY_TYPE:()=>ji,OPERATOR_LABELS:()=>ki});let ki={"is equal to":`等于`,"is not equal to":`不等于`,exists:`存在`,"does not exist":`不存在`,"is empty":`为空`,"is not empty":`不为空`,contains:`包含`,"does not contain":`不包含`,"starts with":`开头为`,"ends with":`结尾为`,"is greater than":`大于`,"is less than":`小于`,"is greater than or equal to":`大于等于`,"is less than or equal to":`小于等于`,"is true":`为真`,"is false":`为假`,"is before":`早于`,"is after":`晚于`,"is before or equal to":`早于或等于`,"is after or equal to":`晚于或等于`,"length equal to":`长度等于`,"length not equal to":`长度不等于`,"length greater than":`长度大于`,"length less than":`长度小于`,"length greater than or equal to":`长度大于等于`,"length less than or equal to":`长度小于等于`},Ai={string:`字符串`,number:`数字`,date:`日期`,boolean:`布尔值`,array:`数组`,object:`对象`},ji={string:[`is equal to`,`is not equal to`,`contains`,`does not contain`,`starts with`,`ends with`,`exists`,`does not exist`,`is empty`,`is not empty`,`length equal to`,`length not equal to`,`length greater than`,`length less than`,`length greater than or equal to`,`length less than or equal to`],number:[`is equal to`,`is not equal to`,`is greater than`,`is less than`,`is greater than or equal to`,`is less than or equal to`,`exists`,`does not exist`],date:[`is equal to`,`is not equal to`,`is before`,`is after`,`is before or equal to`,`is after or equal to`,`exists`,`does not exist`],boolean:[`is equal to`,`is not equal to`,`is true`,`is false`,`exists`,`does not exist`],array:[`exists`,`does not exist`,`is empty`,`is not empty`,`contains`,`does not contain`,`length equal to`,`length not equal to`,`length greater than`,`length less than`,`length greater than or equal to`,`length less than or equal to`],object:[`exists`,`does not exist`,`is empty`,`is not empty`]};var Mi=class extends n{constructor(...e){super(...e),this.type=`if`,this.label=`条件判断`,this.description=`根据条件判断执行不同的分支`,this.category=`流程控制`,this.currentConfig=null}defineInputs(){return[{name:`config`,type:`object`,description:`条件配置`,defaultValue:this.getDefaultConfig(),required:!1}]}defineOutputs(){return this.currentConfig?this.getOutputsForConfig(this.currentConfig):this.getOutputsForConfig(this.getDefaultConfig())}getOutputsForConfig(e){let t=e.conditions||[],n=Math.max(t.length,1),r=[];for(let e=0;e<n;e++){let n=t[e];r.push({name:this.getConditionOutputId(e),type:`any`,description:n?this.describeCondition(n):`未配置条件`})}return r.push({name:`else`,type:`any`,description:`所有条件都不满足时执行`}),r}updateConfig(e){this.currentConfig=e}getDefaultConfig(){return{conditions:[{logic:`and`,subConditions:[{field:``,dataType:`string`,operator:`is equal to`,value:``}]}]}}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#7c3aed`],icon:`❓`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`config`,this.getDefaultConfig());this.updateConfig(t);let n=Array.isArray(t.conditions)?t.conditions:[];console.log(`[IfNode] 开始评估条件，条件数量:`,n.length),console.log(`[IfNode] 原始条件配置:`,JSON.stringify(n,null,2));let r=n.map((e,t)=>{console.log(`\n[IfNode] 评估条件 ${t+1}:`,{logic:e.logic,subConditionsCount:e.subConditions.length});let n=e.subConditions.map((e,t)=>{console.log(`  [IfNode] 子条件 ${t+1} - 原始值:`,{field:e.field,value:e.value,operator:e.operator,dataType:e.dataType});let n=this.resolveOperandValue(e.field,e.dataType),r=this.resolveOperandValue(e.value,e.dataType);if(console.log(`  [IfNode] 子条件 ${t+1} - 解析后的值:`,{actualValue:n,targetValue:r,actualType:typeof n,targetType:typeof r}),this.isEmptyCondition(e.field,e.value,e.operator))return console.log(`  [IfNode] 子条件 ${t+1} - 未配置（左右值都为空），返回 false`),{...e,actualValue:n,targetValue:r,result:!1};let i=this.compareValues(n,r,e.operator,e.dataType);return console.log(`  [IfNode] 子条件 ${t+1} - 比较结果:`,i),{...e,actualValue:n,targetValue:r,result:i}}),r=e.logic===`or`?n.some(e=>e.result):n.every(e=>e.result);return console.log(`[IfNode] 条件 ${t+1} 最终结果:`,{logic:e.logic,subResults:n.map(e=>e.result),conditionResult:r}),{index:t,outputId:this.getConditionOutputId(t),logic:e.logic,subResults:n,result:r}}),i=r.findIndex(e=>e.result),a=i!==-1;console.log(`
[IfNode] 条件评估汇总:`,{totalConditions:r.length,firstPassedIndex:i,anyPassed:a,allResults:r.map((e,t)=>({index:t,outputId:e.outputId,result:e.result}))});let o={};r.forEach((e,t)=>{o[e.outputId]=t===i?{branch:e.outputId,passed:!0,evaluation:e,allEvaluations:r}:void 0}),o.else=a?void 0:{branch:`else`,passed:!1,allEvaluations:r};let s=i===-1?null:r[i];return console.log(`[IfNode] 最终输出端口:`,{selectedBranch:s?s.outputId:`else`,outputKeys:Object.keys(o),outputsWithData:Object.entries(o).filter(([e,t])=>t!==void 0).map(([e])=>e)}),this.createOutput(o,{branch:s?s.outputId:`else`,passed:a,evaluations:r},s?`条件${i+1}满足`:`所有条件都不满足，执行 else`)}catch(e){return this.createError(e)}}getConditionOutputId(e){return`condition-${e}`}describeCondition(e){let{logic:t,subConditions:n}=e;if(!n||n.length===0)return`未配置子条件`;if(n.length===1)return this.describeSubCondition(n[0]);let r=t===`and`?` 且 `:` 或 `,i=n.map(e=>this.describeSubCondition(e)).join(r);return i.length>60?i.slice(0,57)+`...`:i}describeSubCondition(e){if(!e)return`未配置`;let t=this.formatOperand(e.field,`输入值`),n=ki[e.operator]||e.operator;if([`exists`,`does not exist`,`is empty`,`is not empty`,`is true`,`is false`].includes(e.operator))return`${t} ${n}`;let r=this.truncateValue(e.value,20,`''`);return`${t} ${n} ${r}`}truncateValue(e,t=48,n=``){let r=this.formatOperand(e,n);return r?r.length<=t?r:`${r.slice(0,t-1)}…`:n}formatOperand(e,t=``){if(e==null)return t;if(typeof e==`string`){let n=e.trim();return n.length>0?n:t}if(typeof e==`number`||typeof e==`boolean`)return String(e);if(e instanceof Date)return e.toISOString();try{return JSON.stringify(e)}catch{return String(e)}}isEmptyCondition(e,t,n){return[`exists`,`does not exist`,`is empty`,`is not empty`,`is true`,`is false`].includes(n)?this.isOperandEmpty(e):this.isOperandEmpty(e)&&this.isOperandEmpty(t)}isOperandEmpty(e){return e==null?!0:typeof e==`string`?e.trim()===``:!1}resolveOperandValue(e,t){return e==null?e:this.coerceValueByType(e,t)}coerceValueByType(e,t){if(e==null)return e;switch(t){case`number`:{if(typeof e==`number`)return e;if(typeof e==`boolean`)return e?1:0;if(typeof e==`string`){let t=Number(e);return Number.isNaN(t)?e:t}let t=Number(e);return Number.isNaN(t)?e:t}case`boolean`:if(typeof e==`boolean`)return e;if(typeof e==`number`)return e!==0;if(typeof e==`string`){let t=e.toLowerCase();if([`true`,`1`,`yes`].includes(t))return!0;if([`false`,`0`,`no`].includes(t))return!1}return!!e;case`date`:if(e instanceof Date)return e;if(typeof e==`number`)return new Date(e);if(typeof e==`string`){let t=new Date(e);return Number.isNaN(t.getTime())?e:t}return e;case`array`:if(Array.isArray(e))return e;if(typeof e==`string`){let t=e.trim();if(!t)return[];try{let n=JSON.parse(t);return Array.isArray(n)?n:e}catch{return e}}return e;case`object`:if(e&&typeof e==`object`&&!Array.isArray(e))return e;if(typeof e==`string`){let t=e.trim();if(!t)return{};try{let n=JSON.parse(t);return n&&typeof n==`object`?n:e}catch{return e}}return e;default:return typeof e==`string`?e:String(e)}}compareValues(e,t,n,r){console.log(`    [IfNode.compareValues] 比较参数:`,{actual:e,target:t,operator:n,dataType:r,actualType:typeof e,targetType:typeof t});let i;switch(n){case`is equal to`:return i=this.compareEquality(e,t,r),console.log(`    [IfNode.compareValues] is equal to 结果:`,i),i;case`is not equal to`:return!this.compareEquality(e,t,r);case`exists`:return e!=null;case`does not exist`:return e==null;case`is empty`:return e==null?!0:typeof e==`string`?e.trim().length===0:Array.isArray(e)?e.length===0:typeof e==`object`?Object.keys(e).length===0:!1;case`is not empty`:return e==null?!1:typeof e==`string`?e.trim().length>0:Array.isArray(e)?e.length>0:typeof e==`object`?Object.keys(e).length>0:!0;case`contains`:return typeof e==`string`&&typeof t==`string`||Array.isArray(e)?e.includes(t):!1;case`does not contain`:return typeof e==`string`&&typeof t==`string`||Array.isArray(e)?!e.includes(t):!0;case`starts with`:return typeof e==`string`&&typeof t==`string`?e.startsWith(t):!1;case`ends with`:return typeof e==`string`&&typeof t==`string`?e.endsWith(t):!1;case`is greater than`:return Number(e)>Number(t);case`is less than`:return Number(e)<Number(t);case`is greater than or equal to`:return Number(e)>=Number(t);case`is less than or equal to`:return Number(e)<=Number(t);case`is true`:return e===!0;case`is false`:return e===!1;case`is before`:return new Date(e)<new Date(t);case`is after`:return new Date(e)>new Date(t);case`is before or equal to`:return new Date(e)<=new Date(t);case`is after or equal to`:return new Date(e)>=new Date(t);case`length equal to`:return this.getLength(e)===Number(t);case`length not equal to`:return this.getLength(e)!==Number(t);case`length greater than`:return this.getLength(e)>Number(t);case`length less than`:return this.getLength(e)<Number(t);case`length greater than or equal to`:return this.getLength(e)>=Number(t);case`length less than or equal to`:return this.getLength(e)<=Number(t);default:return!1}}getLength(e){return typeof e==`string`||Array.isArray(e)?e.length:typeof e==`object`&&e?Object.keys(e).length:0}compareEquality(e,t,n){let r=this.normalizeEqualityValue(e,n),i=this.normalizeEqualityValue(t,n);return n===`array`||n===`object`?Di(r,i):r===i}normalizeEqualityValue(e,t){if(e==null)return e;switch(t){case`number`:{let t=Number(e);return Number.isNaN(t)?e:t}case`boolean`:if(typeof e==`boolean`)return e;if(typeof e==`string`){let t=e.trim().toLowerCase();if(t===`true`||t===`1`)return!0;if(t===`false`||t===`0`)return!1}return typeof e==`number`?e===1:!!e;case`date`:{let t=e instanceof Date?e.getTime():new Date(e).getTime();return Number.isNaN(t)?e:t}case`string`:return String(e);default:return e}}},Ni=t({CodeNode:()=>Fi});let Pi=/^[A-Za-z][A-Za-z0-9_]*$/;var Fi=class extends n{constructor(...e){super(...e),this.type=`code`,this.label=`代码执行`,this.description=`执行自定义 TypeScript/JavaScript 代码`,this.category=`数据处理`}defineInputs(){return[{name:`dataItems`,type:`array`,description:`参数对象（如提供则覆盖由 dataItems 构建的参数）`,required:!1},{name:`code`,type:`string`,description:`动态代码（如提供则覆盖配置中的 code）`,required:!1}]}defineOutputs(){return[{name:`result`,type:`any`,description:`执行结果`}]}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#7c3aed`],showIcon:!0}}getDefaultConfig(){return{code:`export async function main(params) {
  return {
    receivedKeys: Object.keys(params),
    example: params,
  };
}`,dataItems:[]}}shouldUseCache(e,t){return!1}async execute(e,t){try{let t=this.getDefaultConfig(),n=this.getInput(e,`code`,``),r=typeof n==`string`&&n.trim()?n:void 0,i=this.getInput(e,`dataItems`,null),a=Array.isArray(i),o=i&&typeof i==`object`&&!a?i:void 0,s=r??t.code,c=o??this.buildParams(a?i:t.dataItems),l=this.prepareRuntime(s);try{let e=Function(`params`,l)(c),t=e instanceof Promise?await e:e,n={result:t};return this.createOutput(n,t,this.buildSummary(t,Object.keys(c)))}catch(e){throw Error(`代码执行错误: ${e?.message??e}`)}}catch(e){return this.createError(e)}}buildParams(e){let t={},n=new Set;return e.forEach((e,r)=>{let i=(e?.key??``).trim();if(!i){console.error(`第 ${r+1} 项的键名不能为空`);return}if(!Pi.test(i)){console.error(`第 ${r+1} 项的键名 "${i}" 无效：仅支持以字母开头，由字母、数字或下划线组成`);return}if(n.has(i)){console.error(`检测到重复的键名 "${i}"，请确保唯一`);return}n.add(i),t[i]=e?.value}),t}prepareRuntime(e){return`"use strict";
${this.normalizeExports(e)}

if (typeof main !== "function") {
  throw new Error("main 函数未定义，请确保导出 export function main(params) {}");
}

const result = main(params);
return result;`}normalizeExports(e){let t=e;return[[/export\s+default\s+async\s+function\s+main/g,`async function main`],[/export\s+default\s+function\s+main/g,`function main`],[/export\s+async\s+function\s+main/g,`async function main`],[/export\s+function\s+main/g,`function main`],[/export\s+default\s+main\s*;?/g,``],[/export\s+{\s*main\s+as\s+default\s*};?/g,``],[/export\s+const\s+main\s*=\s*/g,`const main = `],[/export\s+let\s+main\s*=\s*/g,`let main = `],[/export\s+var\s+main\s*=\s*/g,`var main = `]].forEach(([e,n])=>{t=t.replace(e,n)}),t}buildSummary(e,t){let n=t.length>0?t.join(`, `):`无`,r=this.formatValue(e);return`main(params) 执行完成 | 参数键: [${n}] | 结果: ${r}`}formatValue(e){if(e===null)return`null`;if(e===void 0)return`undefined`;if(typeof e==`string`)return e.length>40?`"${e.slice(0,37)}..."`:`"${e}"`;if(typeof e==`number`||typeof e==`boolean`)return String(e);if(Array.isArray(e))return`Array(${e.length})`;if(typeof e==`object`){let t=Object.keys(e);if(t.length===0)return`{}`;let n=t.slice(0,3).join(`, `),r=t.length>3?`, ...`:``;return`{ ${n}${r} }`}return String(e)}},Ii=t({ConnectorNode:()=>Li}),Li=class extends n{constructor(...e){super(...e),this.type=`connector`,this.label=`连接`,this.description=`用于优化连接线布局，执行时返回 undefined`,this.category=`工具`}defineInputs(){return[]}defineOutputs(){return[{name:`output`,type:`any`,description:`输出数据（undefined）`}]}getStyleConfig(){return{}}async execute(e,t){return this.createOutput({output:void 0},void 0,`连接节点：已返回 undefined`)}},Ri=t({ArrayFilterNode:()=>Bi,DataMergeNode:()=>zi}),zi=class extends n{constructor(...e){super(...e),this.type=`data-merge`,this.label=`数据合并`,this.description=`将多个输入合并为一个对象`,this.category=`数据处理`}defineInputs(){return[{name:`input1`,type:`any`,description:`输入数据1`,multiple:!0},{name:`input2`,type:`any`,description:`输入数据2`,multiple:!0},{name:`input3`,type:`any`,description:`输入数据3`}]}defineOutputs(){return[{name:`merged`,type:`object`,description:`合并后的对象`}]}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#ec4899`],icon:`🔗`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`input1`),n=this.getInput(e,`input2`),r=this.getInput(e,`input3`),i={data1:t,data2:n,data3:r,mergedAt:new Date().toISOString()};return this.createOutput(i)}catch(e){return this.createError(e)}}},Bi=class extends n{constructor(...e){super(...e),this.type=`array-filter`,this.label=`数组过滤`,this.description=`根据条件过滤数组元素`,this.category=`数据处理`}defineInputs(){return[{name:`array`,type:`array`,description:`输入数组`,required:!0},{name:`condition`,type:`string`,description:`过滤条件（JavaScript 表达式，使用 item 表示当前元素）`,required:!0,defaultValue:`item > 0`}]}defineOutputs(){return[{name:`filtered`,type:`array`,description:`过滤后的数组`},{name:`count`,type:`number`,description:`过滤后的元素数量`}]}getStyleConfig(){return{headerColor:`#10b981`,icon:`🔍`,showIcon:!0,headerStyle:{fontWeight:`600`}}}async execute(e,t){try{let t=this.getInput(e,`array`,[]),n=this.getInput(e,`condition`,`true`);if(!Array.isArray(t))return this.createError(`输入必须是数组类型`);let r=Function(`item`,`return ${n}`),i=t.filter(r);return this.createOutput({filtered:i,count:i.length},i,`过滤完成：${t.length} -> ${i.length} 项`)}catch(e){return this.createError(e)}}},Vi=t({DelayNode:()=>Hi}),Hi=class extends n{constructor(...e){super(...e),this.type=`delay`,this.label=`延迟`,this.description=`暂停工作流执行指定的时间`,this.category=`控制流`}defineInputs(){return[{name:`delay`,type:`number`,description:`延迟时间（毫秒）`,required:!0,defaultValue:1e3}]}defineOutputs(){return[{name:`output`,type:`any`,description:`延迟后输出的数据`}]}getStyleConfig(){return{headerColor:[`#f59e0b`,`#d97706`],icon:`⏱️`,showIcon:!0}}shouldUseCache(e,t){return!1}async execute(e,t){try{let n=this.getInput(e,`delay`,1e3);return console.log(`DelayNode execute`,n),typeof n!=`number`||n<0?this.createError(`延迟时间必须是非负数`):n===0?this.createOutput({output:void 0}):(await this.sleep(n,t.signal),this.createOutput({output:void 0},void 0,`延迟 ${n}ms 完成`))}catch(e){return e instanceof Error&&e.name===`AbortError`?this.createError(`延迟被取消`):this.createError(e)}}sleep(e,t){return new Promise((n,r)=>{if(t?.aborted){let e=Error(`延迟被取消`);e.name=`AbortError`,r(e);return}let i=setTimeout(()=>{o(),n()},e),a=()=>{o();let e=Error(`延迟被取消`);e.name=`AbortError`,r(e)},o=()=>{clearTimeout(i),t?.removeEventListener(`abort`,a)};t?.addEventListener(`abort`,a)})}},Ui=t({EndNode:()=>Wi}),Wi=class extends n{constructor(...e){super(...e),this.type=`end`,this.label=`结束`,this.description=`工作流程的结束节点`,this.category=`控制流`}defineInputs(){return[{name:`input`,type:`any`,description:`接收任意输入`,required:!1}]}defineOutputs(){return[]}getStyleConfig(){return{headerColor:[`#ef4444`,`#dc2626`],icon:`⏹️`,showIcon:!0}}async execute(e,t){let n=this.getInput(e,`input`,null);return{success:!0,summary:`工作流结束`,outputs:{},raw:{completed:!0,timestamp:Date.now(),finalInput:n}}}},Gi=t({ForNode:()=>Ki}),Ki=class extends n{constructor(...e){super(...e),this.type=`for`,this.label=`批处理`,this.description=`遍历集合并运行循环体`,this.category=`流程控制`}defineInputs(){return[{name:`items`,type:`array`,description:`输入集合`,required:!1}]}defineOutputs(){return[{name:`loop`,type:`any`,description:`循环体`},{name:`next`,type:`any`,description:`循环结束`}]}getStyleConfig(){return{headerColor:[`#f97316`,`#ea580c`],showIcon:!0}}async execute(e,t){try{let n=this.getInput(e,`items`,[]);if(!Array.isArray(n))throw Error(`循环源数据必须是数组`);let r=t.nodeData||{},i={...this.getDefaultConfig(),...r.config||{}};if(!i.containerId)throw Error(`For 节点未配置循环体容器`);if(!t.executeContainer)throw Error(`执行上下文缺少 executeContainer 方法`);let a=n.map((e,t)=>({[i.itemName]:e,[i.indexName]:t,list:n}));if(a.length===0)return this.createOutput({next:{totalCount:0,executedCount:0,successCount:0,errorCount:0,results:[],summary:`无迭代数据`}},{count:0},`无迭代数据`);let o=i.pagination,s=o?.enabled??!1,c=o?.pageSize??10,l=o?.currentPage??1,u=a,d=0,f=a.length;s&&c>0?(d=(l-1)*c,f=Math.min(d+c,a.length),u=a.slice(d,f),console.log(`[ForNode] 启用分页：第 ${l} 页，每页 ${c} 条，执行 ${u.length} 次迭代（总共 ${a.length} 次）`)):console.log(`[ForNode] 开始执行循环，共 ${a.length} 次迭代`);let p=[];for(let e=0;e<u.length;e++){let n=d+e,r=u[e]||{};console.log(`[ForNode] 执行第 ${n+1}/${a.length} 次迭代`,r);try{let e=await t.executeContainer(i.containerId,r);p.push({index:n,variables:r,result:e,status:`success`})}catch(e){let t=e instanceof Error?e.message:String(e);if(console.error(`[ForNode] 第 ${n+1} 次迭代失败:`,t),p.push({index:n,variables:r,error:t,status:`error`}),!i.errorHandling?.continueOnError)throw e}}let m=a.length,h=u.length,g=p.filter(e=>e.status===`success`).length,_=p.filter(e=>e.status===`error`).length,v={next:{totalCount:m,executedCount:h,successCount:g,errorCount:_,results:p,pagination:s?{enabled:!0,currentPage:l,pageSize:c,totalPages:Math.ceil(m/c),startIndex:d,endIndex:f-1}:void 0,summary:s?`第 ${l} 页：执行 ${h} 次，成功 ${g} 次，失败 ${_} 次`:`循环执行 ${h} 次，成功 ${g} 次，失败 ${_} 次`}};return this.createOutput(v,{totalCount:m,executedCount:h,successCount:g,errorCount:_},v.next.summary)}catch(e){return this.createError(e)}}getDefaultConfig(){return{mode:`variable`,variable:``,range:{start:0,end:10,step:1},itemName:`item`,indexName:`index`,containerId:null,errorHandling:{continueOnError:!1}}}},qi=t({HttpRequestNode:()=>Ji,JsonParseNode:()=>Yi,ObjectGetNode:()=>Xi}),Ji=class extends n{constructor(...e){super(...e),this.type=`http-request`,this.label=`HTTP 请求`,this.description=`发送 HTTP 请求并返回响应`,this.category=`网络`}defineInputs(){return[{name:`url`,type:`string`,description:`请求 URL`,required:!0},{name:`method`,type:`string`,description:`请求方法（GET/POST/PUT/DELETE/PATCH）`,defaultValue:`GET`},{name:`headers`,type:`object`,description:`请求头（JSON 对象）`,defaultValue:{}},{name:`body`,type:`any`,description:`请求体（POST/PUT/PATCH 时使用）`},{name:`timeout`,type:`number`,description:`超时时间（毫秒）`,defaultValue:3e4}]}defineOutputs(){return[{name:`data`,type:`any`,description:`响应数据`},{name:`status`,type:`number`,description:`HTTP 状态码`},{name:`headers`,type:`object`,description:`响应头`},{name:`success`,type:`boolean`,description:`请求是否成功（状态码 2xx）`}]}getStyleConfig(){return{headerColor:[`#3b82f6`,`#06b6d4`],icon:`🌐`,showIcon:!0,bodyStyle:{minWidth:`240px`}}}async execute(e,t){try{let n=this.getInput(e,`url`),r=this.getInput(e,`method`,`GET`),i=this.getInput(e,`headers`,{}),a=this.getInput(e,`body`),o=this.getInput(e,`timeout`,3e4),s=this.validateInputs(e);if(!s.valid)return this.createError(s.errors.join(`; `));if(t.signal?.aborted)return this.createError(`请求已中止`);let c={method:r,headers:{"Content-Type":`application/json`,...i},signal:t.signal};[`POST`,`PUT`,`PATCH`].includes(r)&&a!==void 0&&(c.body=typeof a==`string`?a:JSON.stringify(a));let l=new AbortController,u=setTimeout(()=>l.abort(),o);try{let e=await fetch(n,{...c,signal:l.signal});clearTimeout(u);let t,i=e.headers.get(`content-type`);t=i?.includes(`application/json`)?await e.json():i?.includes(`text/`)?await e.text():await e.blob();let a={};e.headers.forEach((e,t)=>{a[t]=e});let o=e.ok;return this.createOutput({data:t,status:e.status,headers:a,success:o},t,`${r} ${n} - ${e.status} ${e.statusText}`)}catch(e){if(clearTimeout(u),e.name===`AbortError`)return this.createError(`请求超时`);throw e}}catch(e){return this.createError(e)}}},Yi=class extends n{constructor(...e){super(...e),this.type=`json-parse`,this.label=`JSON 解析`,this.description=`将 JSON 字符串解析为对象`,this.category=`数据处理`}defineInputs(){return[{name:`json`,type:`string`,description:`JSON 字符串`,required:!0}]}defineOutputs(){return[{name:`data`,type:`object`,description:`解析后的对象`}]}getStyleConfig(){return{headerColor:`#8b5cf6`,icon:`📋`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`json`,``),n=this.validateInputs(e);if(!n.valid)return this.createError(n.errors.join(`; `));let r=JSON.parse(t);return this.createOutput(r,r,`解析成功`)}catch(e){return this.createError(`JSON 解析失败: ${e.message}`)}}},Xi=class extends n{constructor(...e){super(...e),this.type=`object-get`,this.label=`对象取值`,this.description=`从对象中提取指定路径的值`,this.category=`数据处理`}defineInputs(){return[{name:`object`,type:`object`,description:`输入对象`,required:!0},{name:`path`,type:`string`,description:`对象路径（如 "user.name" 或 "items[0].id"）`,required:!0},{name:`defaultValue`,type:`any`,description:`默认值（路径不存在时返回）`}]}defineOutputs(){return[{name:`value`,type:`any`,description:`提取的值`}]}getStyleConfig(){return{headerColor:`#f59e0b`,icon:`🔑`,showIcon:!0}}async execute(e,t){try{let t=this.getInput(e,`object`),n=this.getInput(e,`path`,``),r=this.getInput(e,`defaultValue`),i=this.validateInputs(e);if(!i.valid)return this.createError(i.errors.join(`; `));let a=this.getValueByPath(t,n,r);return this.createOutput(a,a,`提取路径: ${n}`)}catch(e){return this.createError(e)}}getValueByPath(e,t,n){if(!e||!t)return n;let r=t.replace(/\[(\w+)\]/g,`.$1`).split(`.`).filter(e=>e.length>0),i=e;for(let e of r){if(i==null)return n;i=i[e]}return i===void 0?n:i}},Zi=t({NoteNode:()=>Qi}),Qi=class extends n{constructor(...e){super(...e),this.type=`note`,this.label=`笔记`,this.description=`在工作流中添加注释和说明`,this.category=`工具`}defineInputs(){return[]}defineOutputs(){return[]}getStyleConfig(){return{headerColor:`#fbbf24`,icon:`📝`,showIcon:!0}}async execute(e,t){return{success:!0,summary:`笔记节点（跳过执行）`,outputs:{}}}},$i=t({StartNode:()=>ea}),ea=class extends n{constructor(...e){super(...e),this.type=`start`,this.label=`开始`,this.description=`工作流程的起始节点`,this.category=`控制流`}defineInputs(){return[]}defineOutputs(){return[{name:`output`,type:`any`,description:`开始信号`}]}getStyleConfig(){return{headerColor:[`#10b981`,`#059669`],showIcon:!0}}async execute(e,t){return console.log(`[StartNode execute]`,t),this.createOutput({output:{started:!0,timestamp:Date.now(),workflowId:t.workflow?.workflowId,datas:{name:`John Doe`,age:30,address:{street:`123 Main St`,city:`Anytown`}},lists:[{name:`John Doe`,age:30},{name:`IXOA Doe`,age:10},{name:`UN NJH Doe`,age:25}],maps:{name:`John Doe`,age:30}}})}},ta=t({TextProcessNode:()=>na}),na=class extends n{constructor(...e){super(...e),this.type=`text-process`,this.label=`文本处理`,this.description=`对输入文本进行转换处理`,this.category=`文本工具`}defineInputs(){return[{name:`text`,type:`string`,description:`输入文本`,required:!0},{name:`mode`,type:`string`,description:`处理模式`,defaultValue:`uppercase`,options:[{label:`大写`,value:`uppercase`},{label:`小写`,value:`lowercase`},{label:`反转`,value:`reverse`}]},{name:`prefix`,type:`string`,description:`添加前缀`,defaultValue:``}]}defineOutputs(){return[{name:`result`,type:`string`,description:`处理后的文本`},{name:`length`,type:`number`,description:`文本长度`}]}getStyleConfig(){return{headerColor:`#3b82f6`,icon:`📝`,showIcon:!0,bodyStyle:{minWidth:`200px`}}}async execute(e,t){try{let t=this.getInput(e,`text`,``).toString(),n=this.getInput(e,`mode`,`uppercase`),r=this.getInput(e,`prefix`,``),i=this.validateInputs(e);if(!i.valid)return this.createError(i.errors.join(`; `));let a=t;switch(n){case`uppercase`:a=t.toUpperCase();break;case`lowercase`:a=t.toLowerCase();break;case`reverse`:a=t.split(``).reverse().join(``);break}return r&&(a=r+a),this.createOutput({result:a,length:a.length})}catch(e){return this.createError(e)}}},ra=t({ImagePreviewNode:()=>ia}),ia=class extends n{constructor(...e){super(...e),this.type=`preview`,this.label=`图片预览`,this.description=`预览图片，支持完整 URL 或相对路径`,this.category=`调试工具`}defineInputs(){return[{name:`imageUrl`,type:`string`,description:`图片 URL`,required:!1},{name:`baseUrl`,type:`string`,description:`基础 URL`,required:!1}]}defineOutputs(){return[{name:`imageUrl`,type:`string`,description:`处理后的图片地址`},{name:`imageInfo`,type:`object`,description:`图片的元数据信息`}]}getStyleConfig(){return{headerColor:[`#8b5cf6`,`#7c3aed`],icon:`🖼️`,showIcon:!0,bodyStyle:{minWidth:`300px`}}}async execute(e,t){try{let t=this.getInput(e,`imageUrl`,``),n=this.getInput(e,`baseUrl`,``),r;if(!t)return this.createError(`请提供图片 URL 或相对路径`);if(t.startsWith(`http://`)||t.startsWith(`https://`))r=t;else{if(!n)return this.createError(`相对路径需要提供 baseUrl`);r=this.concatenateUrl(n,t)}let i={url:r,type:`url`,size:`未知`};try{if(typeof window<`u`&&`Image`in window){let e=await this.getImageDimensions(r);i={...i,width:e.width,height:e.height}}}catch(e){console.warn(`无法获取图片尺寸:`,e)}let a=`图片预览`;return i.width&&i.height&&(a=`图片: ${i.width}x${i.height}`),this.createOutput({imageUrl:r,imageInfo:i},a)}catch(e){return this.createError(e)}}concatenateUrl(e,t){if(t.startsWith(`http://`)||t.startsWith(`https://`))return t;let n=e.endsWith(`/`)?e.slice(0,-1):e,r=t.startsWith(`/`)?t.slice(1):t;return`${n}/${r}`}getImageDimensions(e){return new Promise((t,n)=>{let r=document.createElement(`img`);r.onload=()=>{t({width:r.naturalWidth,height:r.naturalHeight})},r.onerror=()=>{n(Error(`无法加载图片`))},r.src=e,setTimeout(()=>{n(Error(`加载图片超时`))},5e3)})}};let W={},aa={"./nodes/CodeNode.ts":Ni,"./nodes/ConnectorNode.ts":Ii,"./nodes/DataTransformNode.ts":Ri,"./nodes/DelayNode.ts":Vi,"./nodes/EndNode.ts":Ui,"./nodes/ForNode.ts":Gi,"./nodes/HttpRequestNode.ts":qi,"./nodes/IfNode.ts":Oi,"./nodes/NoteNode.ts":Zi,"./nodes/StartNode.ts":$i,"./nodes/TextProcessNode.ts":ta,"./nodes/previewNode.ts":ra};for(let e in aa){let t=aa[e];for(let e in t){let n=t[e];if(typeof n==`function`&&n.prototype)try{let e=new n;e&&typeof e.type==`string`&&(W[e.type]=n)}catch{}}}function oa(){return Object.values(W).map(e=>new e().getMetadata())}let G=`[FlowWorker]`,K=null,sa=!1,q={executionId:null,workflowId:null},J=e=>self.postMessage(e),ca=()=>({executionId:q.executionId??void 0,workflowId:q.workflowId??void 0}),la=[];function Y(){return la}function X(e){la=e.slice(-1e3)}function ua(e,t){try{let n={};e.nodeResults instanceof Map&&e.nodeResults.forEach((e,t)=>{n[t]=e});let r={executionId:e.executionId,workflowId:e.workflowId,success:e.success,startTime:e.startTime,endTime:e.endTime,duration:e.duration,error:e.error,executedNodeCount:e.executedNodeIds.length,skippedNodeCount:e.skippedNodeIds.length,cachedNodeCount:e.cachedNodeIds.length,executedNodeIds:e.executedNodeIds,skippedNodeIds:e.skippedNodeIds,cachedNodeIds:e.cachedNodeIds,nodeResults:n,nodes:t?.nodes,edges:t?.edges},i=Y();i.push(r),X(i),console.log(`${G} 已保存执行历史:`,r.executionId)}catch(e){console.error(`${G} 添加执行历史失败:`,e)}}function da(e,t,n=1,r=20){try{let i=Y();t&&(i=i.filter(e=>e.workflowId===t)),i.sort((e,t)=>t.startTime-e.startTime);let a=i.length,o=(n-1)*r,s=o+r,c=i.slice(o,s);J({type:`HISTORY_DATA`,payload:{requestId:e,history:c,total:a,page:n,pageSize:r}}),console.log(`${G} 已返回历史记录，第 ${n} 页，共 ${c.length} 条（总计 ${a} 条）`,t?`(工作流: ${t})`:`(全部)`)}catch(e){console.error(`${G} 获取执行历史失败:`,e)}}function fa(e){try{if(e){let t=Y().filter(t=>t.workflowId!==e);X(t),console.log(`${G} 已清空工作流历史:`,e)}else la=[],console.log(`${G} 已清空所有执行历史`)}catch(e){console.error(`${G} 清空执行历史失败:`,e)}}function pa(e){try{let t=Y().filter(t=>t.executionId!==e);X(t),console.log(`${G} 已删除执行历史:`,e)}catch(e){console.error(`${G} 删除执行历史失败:`,e)}}let Z=()=>{if(!q.executionId||!q.workflowId)throw Error(`执行上下文未初始化`);return{executionId:q.executionId,workflowId:q.workflowId}},Q=e=>{J({type:`STATE_CHANGE`,payload:{...ca(),state:e}})},$=()=>{q.executionId=null,q.workflowId=null},ma=(e,t,n)=>{let r=Date.now();return{success:!1,executionId:e,workflowId:t,startTime:r,endTime:r,duration:0,nodeResults:new Map,executedNodeIds:[],skippedNodeIds:[],cachedNodeIds:[],strategy:`full`,error:n}},ha=e=>{let t=e.workflowId??q.workflowId??``;return e.result&&e.workflowId?e:{...e,workflowId:t,result:e.result??ma(e.executionId,t,e.error)}},ga=e=>({...e,onExecutionStart:t=>{q.executionId=t.executionId,q.workflowId=t.workflowId,J({type:`EXECUTION_START`,payload:t}),Q(`running`),e?.onExecutionStart?.(t)},onExecutionComplete:t=>{q.executionId=t.executionId,q.workflowId=t.workflowId,J({type:`EXECUTION_COMPLETE`,payload:t}),Q(`completed`),e?.onExecutionComplete?.(t),$()},onExecutionError:t=>{let n=ha(t);q.executionId=n.executionId,q.workflowId=n.workflowId,J({type:`EXECUTION_ERROR`,payload:n}),Q(`error`),e?.onExecutionError?.(n),$()},onNodeStart:t=>{let n=Z();J({type:`NODE_START`,payload:{...n,nodeId:t}}),e?.onNodeStart?.(t)},onNodeComplete:(t,n)=>{let r=Z();J({type:`NODE_COMPLETE`,payload:{...r,nodeId:t,result:n}}),e?.onNodeComplete?.(t,n)},onNodeError:(t,n)=>{let r=Z();J({type:`NODE_ERROR`,payload:{...r,nodeId:t,error:n.message}}),e?.onNodeError?.(t,n)},onProgress:t=>{J({type:`PROGRESS`,payload:{...ca(),progress:t}}),e?.onProgress?.(t)},onCacheHit:(t,n)=>{let r=Z();J({type:`CACHE_HIT`,payload:{...r,nodeId:t,cachedResult:n}}),e?.onCacheHit?.(t,n)},onIterationUpdate:(t,n)=>{let r=Z();J({type:`ITERATION_UPDATE`,payload:{...r,nodeId:t,iterationData:n}}),e?.onIterationUpdate?.(t,n)}}),_a=(e,t,n)=>{let r=t instanceof Error?t.message:String(t),i=q.executionId??`exec_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,a=q.workflowId??e.workflow_id,o=ma(i,a,r),s={executionId:i,workflowId:a,error:r,result:o};ua(o,e),J({type:`EXECUTION_ERROR`,payload:s}),Q(`error`),n?.onExecutionError?.(s),$()};function va(){try{console.log(`${G} 开始初始化...`,W);let e=y(W);console.log(`${G} 已加载 ${e.getAllTypes().length} 个节点类型:`,e.getAllTypes()),K=new _(e),sa=!0,J({type:`INITIALIZED`}),console.log(`${G} 初始化完成`)}catch(e){console.error(`${G} 初始化失败:`,e);let t={type:`ERROR`,payload:{message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}};J(t)}}async function ya(e,t){if(!K)throw Error(`执行器未初始化`);try{console.log(`${G} 开始执行工作流:`,e.workflow_id);let n=ga(t),r=await K.execute(e,n).catch(e=>{throw e});return console.log(`${G} 工作流执行完成:`,r),ua(r,e),r}catch(n){console.error(`${G} 工作流执行失败:`,n),_a(e,n,t)}}function ba(){K&&(K.pause(),Q(`paused`),console.log(`${G} 执行已暂停`))}function xa(){K&&(K.resume(),Q(`running`),console.log(`${G} 执行已恢复`))}function Sa(){K&&(K.stop(),Q(`cancelled`),$(),console.log(`${G} 执行已停止`))}function Ca(e,t){if(!K)return;let n=K.getCacheStats(e);J({type:`CACHE_STATS`,payload:{requestId:t,stats:n}})}function wa(e){K&&(K.clearCache(e),console.log(`${G} 已清空缓存:`,e))}function Ta(){K&&(K.clearAllCache(),console.log(`${G} 已清空所有缓存`))}function Ea(e){try{let t=oa().map(e=>({type:e.type,label:e.label,description:e.description,category:e.category,icon:e.style?.icon,tags:[],inputs:e.inputs.map(e=>({name:e.name,type:e.type,description:e.description,required:e.required,defaultValue:e.defaultValue,options:e?.options??[]})),outputs:e.outputs.map(e=>({name:e.name,type:e.type,description:e.description}))}));J({type:`NODE_LIST`,payload:{requestId:e,nodes:t}}),console.log(`${G} 已返回节点列表，共 ${t.length} 个节点`)}catch(e){console.error(`${G} 获取节点列表失败:`,e)}}self.addEventListener(`message`,async e=>{let t=e.data;try{switch(t.type){case`INIT`:va();break;case`EXECUTE`:if(!sa)throw Error(`执行器未初始化，请先发送 INIT 消息`);await ya(t.payload.workflow,t.payload.options);break;case`PAUSE`:ba();break;case`RESUME`:xa();break;case`STOP`:Sa();break;case`GET_CACHE_STATS`:Ca(t.payload.workflowId,t.payload.requestId);break;case`CLEAR_CACHE`:wa(t.payload.workflowId);break;case`CLEAR_ALL_CACHE`:Ta();break;case`GET_NODE_LIST`:Ea(t.payload.requestId);break;case`GET_HISTORY`:da(t.payload.requestId,t.payload.workflowId,t.payload.page,t.payload.pageSize);break;case`CLEAR_HISTORY`:fa(t.payload.workflowId);break;case`DELETE_HISTORY`:pa(t.payload.executionId);break;default:console.warn(`${G} 未知消息类型:`,t)}}catch(e){console.error(`${G} 处理消息时出错:`,e);let t={type:`ERROR`,payload:{message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}};J(t)}}),console.log(`${G} VueFlow 执行 Worker 已启动`)})();