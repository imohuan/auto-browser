import{Et as e,Yt as t,at as n,i as r,yt as i}from"./index-BBQwUZyz.js";const a={STARTED:`workflow:started`,COMPLETED:`workflow:completed`,ERROR:`workflow:error`,PAUSED:`workflow:paused`,RESUMED:`workflow:resumed`,LOOP_STARTED:`workflow:loop:started`,ITERATION_STARTED:`workflow:loop:iteration-started`,ITERATION_COMPLETED:`workflow:loop:iteration-completed`,LOOP_COMPLETED:`workflow:loop:completed`,NODE_STATUS:`workflow:node:status`,NODE_PROGRESS:`workflow:node:progress`,NODE_LOG:`workflow:node:log`,EDGE_ACTIVE:`workflow:edge:active`,EDGE_INACTIVE:`workflow:edge:inactive`,RESTORE_REQUEST:`workflow:restore:request`,RESTORE_DATA:`workflow:restore:data`};var o=null,s=null;function c(e,i){let a=t(null),o=t(`disconnected`),s=t([]),c=t(null),l=t(null),u=t(null),d=t(null),f=t(null),p=r(),m=!1;function h(){if(!(o.value===`connecting`||o.value===`ready`)){o.value=`connecting`,l.value=null,console.log(`[ServerClient] æ­£åœ¨è¿žæŽ¥åˆ°æœåŠ¡å™¨: ${i}`);try{a.value=new WebSocket(i),a.value.onopen=g,a.value.onmessage=_,a.value.onerror=y,a.value.onclose=b}catch(e){y(e)}}}function g(){console.log(`[ServerClient] âœ… WebSocket è¿žæŽ¥å·²å»ºç«‹`),o.value=`ready`,m=!1,x({type:`INIT`}),S()}function _(t){try{let n=JSON.parse(t.data);switch(n.type){case`INITIALIZED`:v(n.payload);break;case`WORKFLOW_EVENT`:e.emit(n.payload.eventType,n.payload.eventData);break;case`ERROR`:console.error(`[ServerClient] æœåŠ¡å™¨é”™è¯¯:`,n.payload),l.value=n.payload.message;break;case`PONG`:break;default:console.warn(`[ServerClient] æœªçŸ¥æ¶ˆæ¯ç±»åž‹:`,n)}}catch(e){console.error(`[ServerClient] è§£æžæ¶ˆæ¯å¤±è´¥:`,e)}}function v(e){s.value=e.nodeMetadata,c.value=e.serverId,console.log(`[ServerClient] âœ… å·²ä»ŽæœåŠ¡å™¨åŠ è½½ ${e.nodeMetadata.length} ä¸ªèŠ‚ç‚¹å…ƒæ•°æ®`),console.log(`[ServerClient] æœåŠ¡å™¨ ID: ${e.serverId}`),u.value&&=Promise.resolve()}function y(e){console.error(`[ServerClient] âŒ WebSocket é”™è¯¯:`,e),o.value=`error`,l.value=`WebSocket è¿žæŽ¥é”™è¯¯`,m||(m=!0,p.showError(`æ— æ³•è¿žæŽ¥åˆ°æ‰§è¡ŒæœåŠ¡å™¨`,`åœ°å€ï¼š${i}`,e instanceof ErrorEvent&&e.message?e.message:void 0))}function b(e){console.warn(`[ServerClient] ðŸ”Œ WebSocket è¿žæŽ¥å·²å…³é—­ (code: ${e.code}, reason: ${e.reason||`none`})`),o.value=`disconnected`,C(),e.code!==1e3&&!m&&(m=!0,p.showWarning(`æ‰§è¡ŒæœåŠ¡å™¨è¿žæŽ¥å·²æ–­å¼€`,e.reason?`${e.reason} (code: ${e.code})`:`code: ${e.code}`)),d.value||=(console.log(`[ServerClient] å°†åœ¨ 5 ç§’åŽå°è¯•é‡æ–°è¿žæŽ¥...`),window.setTimeout(()=>{d.value=null,h()},5e3))}function x(e){a.value&&a.value.readyState===WebSocket.OPEN?a.value.send(JSON.stringify(e)):console.warn(`[ServerClient] WebSocket æœªè¿žæŽ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯`)}function S(){f.value=window.setInterval(()=>{x({type:`PING`,payload:{timestamp:Date.now()}})},3e4)}function C(){f.value&&=(clearInterval(f.value),null)}function w(e,t,n,r){if(o.value!==`ready`)throw Error(`å®¢æˆ·ç«¯æœªå°±ç»ªï¼Œæ— æ³•æ‰§è¡Œå·¥ä½œæµ`);x({type:`EXECUTE_WORKFLOW`,payload:{executionId:e,workflowId:t,nodes:n,edges:r}})}async function T(){return o.value===`ready`&&s.value.length>0?Promise.resolve():(u.value||=new Promise(e=>{let t=()=>{o.value===`ready`&&s.value.length>0?e():setTimeout(t,100)};t()}),u.value)}function E(){d.value&&=(clearTimeout(d.value),null),C(),a.value&&=(a.value.close(1e3,`Client disconnecting`),null),o.value=`disconnected`,s.value=[],c.value=null}return h(),{status:n(()=>o.value),nodeMetadata:n(()=>s.value),serverId:n(()=>c.value),error:n(()=>l.value),isReady:n(()=>o.value===`ready`),executeWorkflow:w,waitForReady:T,disconnect:E,reconnect:h}}function l(e,t=`ws://localhost:3001`){return(!o||s!==t)&&(o&&o.disconnect(),o=c(e,t),s=t),o}function u(){o&&(o.disconnect(),o=null,s=null)}function d(t=`ws://localhost:3001`){let n=i(`workflowEmitter`);if(!n)throw Error(`workflowEmitter not provided`);let r=l(n,t);return e(()=>{o===r&&u()}),r}export{a as i,u as n,d as r,l as t};